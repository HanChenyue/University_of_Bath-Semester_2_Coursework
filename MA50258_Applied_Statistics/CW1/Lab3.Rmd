---
title: 'MA50258 Lab 3'
author: "Your name here"
output:
  html_document:
    number_sections: no
    toc: yes
    toc_float: yes
    toc_depth: 2
    code_download: yes
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = TRUE)
# The option warning = FALSE supreses all the output warnings! 
# You can  override this option in each code chunk as shown in some cases below!
```

# Introduction

You can download the `*.Rmd` version of this page by clicking in the
**Code button** at the top right of this page. If the **Code button**
does not work you can download the 'Lab3.Rmd' file from the Moodle page.
You should use RStudio,

## Packages

Below is the list of packages that we will use in this lab.

```{r}
#| message: false
library(tidyverse) 
library(janitor) # to clean names in a data frame
library(kableExtra) # for nicer tables
library(modelr) # to manipulate model predictions
```

## Instructions

1.  To answer the following questions, simply fill in the code chunks
    with your own code.

2.  You should use the `dplyr`, `ggplot2` as well as base `R` commands
    commands as introduced in the [lecture
    notes](https://github.bath.ac.uk/pages/kai21/MA50258-lecture-notes/).

3.  Label your plots appropriately as well as ensuring that appropriate
    legends describe different types of objects in the same plot.

4.  Once you complete your answers, knit the corresponding Rmarkdown
    (`.Rmd`) document to produce an HTML file. The name of the HTML file
    should be Lab3.html. You should submit both Rmd and HTML files in
    the [submission point in
    Moodle](https://moodle.bath.ac.uk/mod/assign/view.php?id=1200296).

5.  You should get rid of the introduction section (e.g. all of the
    above) in your submission.

# Gapminder data set

The `gapminder` data frame contains a dataset of economic social
indicators such as gross domestic product (gdp) per capita, population
and life expectancy of many countries over the period from 1952 to 2007
in increments of 5 years.

The data frame `gapminder` has 1704 rows and 6 variables:

-   `country` A factor with 142 levels (eg 142 countries in the data
    set)

-   `continent` A factor with 5 levels

-   `year` An integer vector with years ranging from 1952 to 2007 in
    increments of 5 years.

-   `lifeExp` life expectancy at birth, in years

-   `pop` Total population

-   `gdpPercap` GDP per capita (US dollars, inflation-adjusted)

The data can be loaded into `R` using the following command:

```{r,message=FALSE}
library(gapminder)
gapminder <-
  gapminder %>% 
    clean_names() 
```

# Questions

For all the questions, **only use the subset of the dataset that
corresponds to countries in 1992.**

## Question 1

Use LOESS to fit an empirical regression model of the form
$$E[\verb|life_exp||\verb|gdp_percap|,\verb|pop|]=s_{2,3}(\verb|gdp_percap|,\verb|pop|)$$
where both explanatory variables interact. Then produce a plot of the
effect of

-   `gdp_percap` for the 9 mid-deciles of population

-   `pop` for the 9 mid-deciles of GDP per capita

In the same plot, also graph the scatter of the data points. What can
you conclude from these plots?

```{r}
gapminder <- gapminder %>% filter(year == 1992)

## Question 1
# loess fit with effect interaction
fit_loess_pop_gdp <- loess(life_exp ~ gdp_percap + pop, data = gapminder)

# Mid-deciles for population (rounded to the nearest 100k)
mid_pts_pop <- quantile(gapminder$pop, probs = seq(0, 19,by = 2)/20) %>% signif(2) # round to nearest 100k
mid_pts_gdp <- quantile(gapminder$gdp_percap, probs = seq(0, 19,by = 2)/20) %>% signif(2) # round to nearest 1000

# LOESS Fit
# Use factor in "pop" to get interaction effects
gapminder_pop_factor <- gapminder %>% mutate(pop = factor(pop))
pred_grid_gdp <- 
  gapminder_pop_factor %>% 
  data_grid(
    gdp_percap = seq_range(gdp_percap, 1000),
    pop = mid_pts_pop) %>% 
  add_predictions(fit_loess_pop_gdp,
                  var = "life_exp",
                  type = "response")


library(scales)
# Define discrete labels for the population groups
pop_labels <- paste("Decile", 1:9)

# Plot
```

Fit a Generalised Additive Model (GAM) of the form
$$E[\verb|life_exp||\verb|gdp_percap|,\verb|pop|]=s_{2,3}(\verb|gdp_percap|,\verb|pop|)$$
where both explanatory variables interact. Then produce a plot of the
effect of

-   `gdp_percap` for the 9 mid-deciles of population

-   `pop` for the 9 mid-deciles of GDP per capita

In the same plot, also graph the scatter of the data points. What can
you conclude from these plots?

## Question 3

Fit a Generalised Additive Model (GAM) of the form
$$E[\verb|life_exp||\verb|gdp_percap|,\verb|pop|]=s_2(\verb|gdp_percap|)+s_3(\verb|pop|)$$
where both explanatory variables interact. Then produce a plot of the
effect of

-   `gdp_percap` for the 9 mid-deciles of population

-   `pop` for the 9 mid-deciles of GDP per capita

In the same plot, also graph the scatter of the data points. What can
you conclude from these plots?
