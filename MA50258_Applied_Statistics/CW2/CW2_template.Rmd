---
title: "MA50258 Applied Statistics: Coursework 2"
author: "09618"
output:
  html_document:
    number_sections: no
    toc: yes
    toc_float: yes
    code_folding: hide
    code_download: yes
---

### Disclaimer:

ChatGPT and GitHub CoPilot used for code and discussion suggestions, debugging purpose, and to check the correctness of the code.

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

```{r libraries,echo= FALSE}
# include your libraries here
# use echo = FALSE if you do not want the Code button to appear 
library(tidyverse)
library(modelr)
library(readr)
library(here)

# Load external libraries
library(dplyr)
library(janitor)
library(ggplot2)
library(kableExtra)
library(MASS)
library(broom)
library(stats)
library(effects)
```

```{r,message=FALSE}
# read in the data
sdg <- read_csv(here("data", "sdg.csv"))
Wine <- read_csv(here("data", "Wine.csv"))
```



```{=html}
<!--
You can include non-coding comments using these delimiters. What is written inside these delimiters wont be knitted into the html document!

Do not change the structure of the document, just fill in the sections as indicated 
You can only change the headings indicated with [*]
-->
```
# Sustainable development goals (SDG) data

## Cleaning the dataset

```{r}
# Use janitor to clean the data
sdg_clean <- sdg %>%
  clean_names() %>%
  remove_empty(c("rows", "cols")) %>% 
  drop_na()
```

## Performing exploratory data analysis

```{r}
# Check the structure of the data
# str(sdg_clean)
```


```{r}
# Plot the distribution of infant mortality rate
ggplot(data = sdg_clean, aes(x = infant_mortality_rate)) +
  geom_histogram(aes(y = ..density..), binwidth = 5, fill = "yellow", colour = "gray") +
  geom_density(colour = "red", size = 1) +
  ggtitle("Distribution of Infant Mortality Rate") +
  xlab("Infant Mortality Rate") +
  ylab("Density")
```
```{r, fig.width = 12, fig.height = 12}
# Plot the infant mortality rate by country
ggplot(data = sdg_clean, aes(x = country, y = infant_mortality_rate, fill = country)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") +
  labs(title = "Infant Mortality Rate by Country", x = "Country", y = "Infant Mortality Rate")
```

Distribution of Infant Mortality Rate

The histogram shows that the distribution of infant_mortality_rate is right-skewed. This implies that most countries have low infant mortality rates, while a few have higher rates when we take a look at the bar plot of infant mortality rate by country, we can see that the distribution is consistent with the histogram. The bar plot shows the infant mortality rate for each country, with some countries having higher rates than others.

```{r}
# Use qqplot to check the distribution of infant mortality rate
qqnorm(sdg_clean$infant_mortality_rate)
qqline(sdg_clean$infant_mortality_rate)
```

Given the skewness in both the histogram and qq-plot, a Poisson distribution may be appropriate for GLM modelling.

We then explore the relationship between infant mortality rate and other variables such as income class, years of education, life expectancy, and GDP per capita.

```{r}
ggplot(data = sdg_clean, aes(x = years_education, y = infant_mortality_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = F, colour = "blue") +
  ggtitle("Years of Education vs. Infant Mortality Rate") +
  xlab("Years of Education") +
  ylab("Infant Mortality Rate")

ggplot(data = sdg_clean, aes(x = life_expectancy, y = infant_mortality_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = F, colour = "blue") +
  ggtitle("Life Expectancy vs. Infant Mortality Rate") +
  xlab("Life Expectancy") +
  ylab("Infant Mortality Rate")

ggplot(data = sdg_clean, aes(x = gdp, y = infant_mortality_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE, colour = "red") +
  ggtitle("GDP vs. Infant Mortality Rate") +
  xlab("GDP per Capita in USD") +
  ylab("Infant Mortality Rate")

# log the GDP values
ggplot(data = sdg_clean, aes(x = log10(gdp), y = infant_mortality_rate)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = F, colour = "blue") +
  ggtitle("log10(GDP) vs. Infant Mortality Rate") +
  xlab("log10(GDP per Capita in USD)") +
  ylab("Infant Mortality Rate")

# GDP vs. Infant Mortality Rate for each continent
ggplot(data = sdg_clean, aes(x = log10(gdp), y = infant_mortality_rate, colour = continent)) +
  geom_point(alpha = 0.5) +
  # geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~continent) +
  ggtitle("GDP vs. Infant Mortality Rate by Continent") +
  xlab("log10(GDP per Capita in USD)") +
  ylab("Infant Mortality Rate")

# GDP vs. Infant Mortality Rate for each income class
ggplot(data = sdg_clean, aes(x = log10(gdp), y = infant_mortality_rate, colour = income_class)) +
  geom_point(alpha = 0.5) +
  # geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~income_class) +
  ggtitle("GDP vs. Infant Mortality Rate by Income Class") +
  xlab("log10(GDP per Capita in USD)") +
  ylab("Infant Mortality Rate")
```

As shown above:

- As years of education increase, infant mortality rates tend to decrease. This suggests that education may play a role in reducing infant mortality rates. A simple linear regression model has shown that the decrease is linear.

- As life expectancy increases, infant mortality rates tend to decrease. This is consistent with the idea that better healthcare and living conditions can lead to lower infant mortality rates. A simple linear regression model has shown that the decrease is linear.

- As GDP per capita increases, infant mortality rates tend to decrease. This suggests that wealthier countries tend to have lower infant mortality rates. The relationship is not strictly linear, as the LOESS curve shows that the decrease is more pronounced at lower GDP levels (around USD $25000) but levels off after that. By log-transforming the GDP values, we can see a clearer linear relationship between GDP and infant mortality rates as shown by a simple linear regression model that the decrease is linear.

- The facet plot of GDP vs. Infant Mortality Rate by continent shows that the relationship between GDP and infant mortality rate varies by continent. In Africa, the the infant mortality rate concentration is high, Asia has a mixed infant mortality rate concentration, America has a moderately low infant mortality rate concentration, and Europe and Oceania have the least infant mortality rate concentrations.

- The facet plot of GDP vs. Infant Mortality Rate by income class shows that the relationship between GDP and infant mortality rate varies by income class. The 'H' (high) income class countries have the lowest infant mortality rates concentration, while the 'UM' (upper-middle) income class countries have mixed level of infant mortality rates concentration. 'LM' (lower-middle) income class countries has a mixed infant mortality rate concentration as a noticeable proportion of countries seems to have high infant mortality rate concentration, and 'L' (low) income class countries have the highest infant mortality rate concentration.

Next, we explore the relationship between income class and infant mortality rate.

```{r}
# Income Class vs. Infant Mortality Rate
ggplot(data = sdg_clean, aes(x = income_class, y = infant_mortality_rate, fill = income_class)) +
  geom_boxplot(colour = "black") +
  scale_fill_manual(values = c("H" = "yellow", "UM" = "orange", "LM" = "red", "L" = "magenta")) +
  ggtitle("Income Class vs. Infant Mortality Rate") +
  xlab("Income Class") +
  ylab("Infant Mortality Rate")
```

```{r}
# Show the top 10 countries with the lowest infant mortality rates and their respective income classes and vice versa
sdg_clean %>%
  arrange(infant_mortality_rate) %>%
  head(10) %>%
  dplyr::select(country, infant_mortality_rate, income_class) %>%
  kable(caption = "Top 10 countries with the lowest infant mortality rates") %>%
  kable_styling(full_width = F)
```

```{r}
# Show the bottom 10 countries with the highest infant mortality rates and their respective income classes
sdg_clean %>%
  arrange(desc(infant_mortality_rate)) %>%
  dplyr::select(country, infant_mortality_rate, income_class) %>%
  head(10) %>%
  kable(caption = "Top 10 countries with the highest infant mortality rates") %>%
  kable_styling(full_width = F)
```

- Infant Mortality Rate by Country

The bar plot displays the infant mortality rate for each country. There is a clear pattern in that as income class decrease from 'H' (upper) income class to 'L' (low) income class, the infant mortality rate tends to increase.

This is also shown that the table that the top 10 countries with the lowest infant mortality rates are all classified as 'H' (upper) income class countries. Conversely, the bottom 10 countries with the highest infant mortality rates are classified as 'L' (low) or 'LM" (low-middle) income class countries. This suggests a strong relationship between income class and infant mortality rate, while also highlight that as income class decreases to 'L' or 'LM', the infant mortality rate will likely increase.


Next, we attempt to find the best linear model to predict infant mortality rate using years of education, GDP per capita, and life expectancy as predictors. Given there are multiple combinations possible, we first start with 7 models and use AIC and R-squared values to determine the best model before checking the significance of the predictors.

- Model 1: $$E(\text{Infant Mortality Rate | Years of Education}) = \beta_0 + \beta_1 \times \text{Years of Education}$$

- Model 2: $$E(\text{Infant Mortality Rate | Years of Education, GDP}) = \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)}$$

- Model 3: $$E(\text{Infant Mortality Rate | Years of Education, GDP, Life Expectancy}) = \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)} + \beta_3 \times \text{Life Expectancy}$$

- Model 4: $$
\begin{array}{rcl}
E(\text{Infant Mortality Rate | Years of Education, GDP, Life Expectancy}) &=& \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)} + \beta_3 \times \text{Life Expectancy}\\
&& + \beta_4 \times \text{Years of Education} \times \text{log10(GDP)}
\end{array}
$$

- Model 5: $$
\begin{array}{rcl}
E(\text{Infant Mortality Rate | Years of Education, GDP, Life Expectancy}) &=& \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)} + \beta_3 \times \text{Life Expectancy}\\
&& + \beta_4 \times \text{Years of Education} \times \text{Life Expectancy}
\end{array}
$$

- Model 6: $$
\begin{array}{rcl}
E(\text{Infant Mortality Rate | Years of Education, GDP, Life Expectancy}) &=& \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)} + \beta_3 \times \text{Life Expectancy}\\
&& + \beta_4 \times \text{log10(GDP)} \times \text{Life Expectancy}
\end{array}
$$

- Model 7: $$
\begin{array}{rcl}
E(\text{Infant Mortality Rate | Years of Education, GDP, Life Expectancy}) &=& \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)} + \beta_3 \times \text{Life Expectancy}\\
&& + \beta_4 \times \text{Years of Education} \times \text{log10(GDP)}\times \text{Life Expectancy}
\end{array}
$$



```{r}
# Using AIC and R-squared to determine the best model
task1_lm_model_1 <- lm(infant_mortality_rate ~ years_education, data = sdg_clean)
task1_lm_model_2 <- lm(infant_mortality_rate ~ years_education + log10(gdp), data = sdg_clean)
task1_lm_model_3 <- lm(infant_mortality_rate ~ years_education + log10(gdp) + life_expectancy, data = sdg_clean)
task1_lm_model_4 <- lm(infant_mortality_rate ~ years_education + log10(gdp) + life_expectancy + years_education * log10(gdp), data = sdg_clean)
task1_lm_model_5 <- lm(infant_mortality_rate ~ years_education + log10(gdp) + life_expectancy + years_education * life_expectancy, data = sdg_clean)
task1_lm_model_6 <- lm(infant_mortality_rate ~ years_education + log10(gdp) + life_expectancy + log10(gdp) * life_expectancy, data = sdg_clean)
task1_lm_model_7 <- lm(infant_mortality_rate ~ years_education + log10(gdp) + life_expectancy + income_class + years_education * log10(gdp) * life_expectancy, data = sdg_clean)

# Generate a table with AIC and R-squared values
kable(data.frame(Model = c("Model 1", "Model 2", "Model 3", "Model 4", "Model 5", "Model 6", "Model 7"),
                 AIC = c(AIC(task1_lm_model_1), AIC(task1_lm_model_2), AIC(task1_lm_model_3), AIC(task1_lm_model_4), AIC(task1_lm_model_5), AIC(task1_lm_model_6), AIC(task1_lm_model_7)),
                 R_squared = c(summary(task1_lm_model_1)$r.squared, summary(task1_lm_model_2)$r.squared, summary(task1_lm_model_3)$r.squared, summary(task1_lm_model_4)$r.squared, summary(task1_lm_model_5)$r.squared, summary(task1_lm_model_6)$r.squared, summary(task1_lm_model_7)$r.squared))) %>% 
  kable_styling(full_width = F)
```

Given Model 7 has the lowest AIC value and the highest R-squared value, thus far, it is the best model to predict infant mortality rate using years of education, GDP per capita, life expectancy, and income class as predictors.

Model 7: $$
\begin{array}{rcl}
E(\text{Infant Mortality Rate | Years of Education, GDP, Life Expectancy}) &=& \beta_0 + \beta_1 \times \text{Years of Education} + \beta_2 \times \text{log10(GDP)} + \beta_3 \times \text{Life Expectancy}\\
&& + \beta_4 \times \text{Years of Education} \times \text{log10(GDP)} \times \text{Life Expectancy}
\end{array}
$$

However, we can check whether the effects are statistically significant by examining if the p-value is less than 0.05

```{r}
model_7_summary <- tidy(task1_lm_model_7)

# Subset to keep only the estimate and p-value columns
model_7_summary_subset <- model_7_summary[, c("term", "estimate", "p.value")]
# 
# # Round the estimate to 2 significant figures and format the p-value
# model_7_summary_subset$estimate <- signif(model_7_summary_subset$estimate, digits = 2)
# model_7_summary_subset$p.value <- formatC(model_7_summary_subset$p.value, format = "e", digits = 2)

# Use kable to create a nicely formatted table
kable(model_7_summary_subset, format = "html", digits = 4) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

It has shown that 'log10(gdp)' and its subsequent interaction terms are not statistically significant as their p-values are greater than 0.05. This suggests that the interaction terms may not be necessary in the model.

Thus, we can simplify the model to:

Final Model:

$$
\begin{array}{rcl}
E(\text{Infant Mortality Rate | Years of Education, Life Expectancy}) &=& \beta_0 + \beta_1 \times \text{Years of Education} +  \beta_3 \times \text{Life Expectancy}\\
&& + \beta_4 \times \text{Years of Education} \times \text{Life Expectancy}
\end{array}
$$

```{r}
task1_lm_model_final <- lm(infant_mortality_rate ~ years_education + life_expectancy + years_education * life_expectancy, data = sdg_clean)

final_model_summary <- tidy(task1_lm_model_final)

# Subset to keep only the estimate and p-value columns
final_model_summary_subset <- final_model_summary[, c("term", "estimate")]

# Use kable to create a nicely formatted table
kable(final_model_summary_subset, format = "html", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

Interpretation:

- Intercept $B_0$: This is the expected value of the Infant Mortality Rate when all other predictors are zero which is 235.54

- Years of Education $B_1$: For each additional year of education, the Infant Mortality Rate decreases by 11.51

- Life Expectancy $B_3$: For each additional year of life expectancy, the Infant Mortality Rate decreases by 2.81

- Interaction Term $B_4$: The interaction term between Years of Education and Life Expectancy is 0.14, the positive coefficient suggests that the effect of Years of Education and Life Expectancy increases the Infant Mortality Rate, indicating that there is a complex relationship at play here.

```{r}
# Generate predictions for the final model
prediction_final_model <- predict(task1_lm_model_final)

# Plot the predictions vs. actual values
ggplot(data = sdg_clean, aes(x = infant_mortality_rate, y = prediction_final_model)) +
  geom_point(alpha = 0.5) +
  geom_abline(colour = "purple", size = 1, alpha = 0.4) +
  ggtitle("Final Model Predictions vs. Actual") +
  xlab("Actual Infant Mortality Rate") +
  ylab("Predicted Infant Mortality Rate")
```


The plot shows the relationship between the actual and predicted infant mortality rates using this model. The purple line represents the predicted values, which closely align with the actual data points. This indicates that this model is effective in predicting infant mortality rates based on years of education, life expectancy, with interaction terms.

```{r}
# Split the life expectancy into 5 quartiles
sdg_clean$life_expectancy_quartile <- cut(sdg_clean$life_expectancy, breaks = quantile(sdg_clean$life_expectancy, probs = seq(0, 1, 0.2)), include.lowest = TRUE)

# Plot the scatterplot with different colours for life expectancy quartiles as linear model and facet wrap by GDP quartile
ggplot(data = sdg_clean, aes(x = years_education, y = infant_mortality_rate, colour = life_expectancy_quartile)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = F) +
  ggtitle("Years of Education vs. Infant Mortality Rate by Life Expectancy Quartile") +
  xlab("Years of Education") +
  ylab("Infant Mortality Rate") +
  labs(colour = "Life Expectancy Quartile (in Years)")
```

By splitting the life expectancy into 5 different levels, we can see how the relationship between years of education and infant mortality rate varies across different life expectancy levels. We noticed that the rate of decrease in infant mortality rate with years of education is more pronounced in countries with lower life expectancy. If life expectancy is high, as years of education increase, the rate of decrease in infant mortality rate is less pronounced.


```{r}
# Using effects library to get the effect of infant mortality rate
eff_lm_infant <- allEffects(task1_lm_model_final)
plot(eff_lm_infant, multiline = TRUE)
```

This plot illustrates the interaction effects between years of education and life expectancy on infant mortality rates, depicting how these two variables jointly influence infant mortality across different contexts of life expectancy.

The plot shows multiple lines, each representing a different fixed value of life expectancy (57, 64, 70, 84 years). As life expectancy increases, the baseline infant mortality rates start at a lower value. This suggests that in contexts with higher life expectancy, which may reflect better overall health and social conditions, infant mortality rates are initially lower. The slope of each line demonstrates the rate of decrease in infant mortality rates with increasing years of education. The steeper slopes at lower life expectancy levels imply that education has a more pronounced effect in reducing infant mortality rates in less developed health contexts. Conversely, in settings with high life expectancy, the impact of education, while still positive, shows a less steep decline in infant mortality rates.

Thus the effect library has shown a close agreement with our final linear model.


Next, we explore two additional models: a log-transformed linear model and a Generalised Linear Model (GLM) to predict infant mortality rates.

Log-Transformed Linear Model:

$$
\begin{array}{rcl}
E(\text{infant_mortality_rate}) &=& \exp\left(\beta_0 + \beta_1 \times \text{years_education} + \beta_2 \times \text{log(gdp)} + \beta_3 \times \text{life_expectancy}\right)\\
&& + \beta_4 \times \text{years_education} \times \text{log(gdp)} \times \text{life_expectancy}
\end{array}
$$


```{r}
# Log-Transformed Linear Model
log_lm_infant <- lm(log(infant_mortality_rate) ~ years_education + log(gdp) + life_expectancy + years_education * log(gdp) * life_expectancy, data = sdg_clean)

log_lm_infant_summary <- tidy(log_lm_infant)[, c("term", "estimate", "p.value")]

log_lm_infant_summary$estimate <- signif(log_lm_infant_summary$estimate, digits = 2)
log_lm_infant_summary$p.value <- formatC(log_lm_infant_summary$p.value, format = "e", digits = 2)

kable(log_lm_infant_summary, format = "html", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped"))
```

```{r}
# Generate predictions for the log-transformed model
prediction_log_lm_infant <- predict(log_lm_infant)
prediction_log_lm_infant_exp <- exp(prediction_log_lm_infant)

ggplot(data = sdg_clean, aes(x = infant_mortality_rate, y = prediction_log_lm_infant_exp)) +
  geom_point(alpha = 0.5) +
  geom_abline(colour = "purple", size = 1, alpha = 0.4) +
  ggtitle("Log-Transformed Linear Model Predictions vs. Actual") +
  xlab("Actual Infant Mortality Rate") +
  ylab("Predicted Infant Mortality Rate")
```


The plots for the log-transformed linear model indicate:

The plot shows the relationship between the actual and predicted infant mortality rates using this model. The purple line represents the predicted values, which closely align with the actual data points. This indicates that this model is effective in predicting infant mortality rates based on years of education, life expectancy, gdp, with interaction terms.

Interpretation:

Since all p-value is less than 0.05, all predictors are statistically significant in the log-transformed linear model. The coefficients indicate the following:

- Intercept $B_0$: This is the expected value of the log-transformed Infant Mortality Rate when all other predictors are zero which is -16.00

- Years of Education $B_1$: For each additional year of education, the log-transformed Infant Mortality Rate increase by 3.80

- ln(gdp) $B_2$: For each additional unit of log-transformed GDP, the log-transformed Infant Mortality Rate increase by 3.00


Generalised Linear Model (GLM):

$E(\text{infant_mortality_rate}) = \exp\left(\beta_0 + \beta_1 \times \text{years_education} + \beta_2 \times \text{gdp} + \beta_3 \times \text{life_expectancy} + \beta_4 \times \text{income_class}\right)$

```{r}
# GLM
glm_infant <- glm(infant_mortality_rate ~ years_education + gdp + life_expectancy + income_class, data = sdg_clean, family = poisson(link = "log"))
summary(glm_infant)
tidy(glm_infant)
```

```{r}
# Generate predictions for the GLM model
prediction_glm_infant <- predict(glm_infant, type = "response")

ggplot(data = sdg_clean, aes(x = infant_mortality_rate, y = prediction_glm_infant)) +
  geom_point(alpha = 0.5) +
  geom_abline(colour = "purple", size = 1, alpha = 0.4) +
  ggtitle("GLM Predictions vs. Actual") +
  xlab("Actual Infant Mortality Rate") +
  ylab("Predicted Infant Mortality Rate")

# ggplot(data = sdg_clean, aes(x = life_expectancy, y = infant_mortality_rate)) +
#   geom_point(alpha = 0.5) +
#   geom_line(aes(y = prediction_glm_infant), colour = "purple", alpha = 0.4) +
#   ggtitle("GLM Effect Plot - Life Expectancy") +
#   xlab("Life Expectancy") +
#   ylab("Infant Mortality Rate")
```
The plots for the GLM model indicate:

- Predictions vs. Actual: The first plot shows that the predictions closely align with the actual infant mortality rates, but there are some deviations for higher values.

- Effect Plot - Life Expectancy: The second plot shows a strong negative relationship between life_expectancy and infant_mortality_rate, which aligns with our earlier observations.

Coefficients for the GLM model indicate that:

- Years of Education: For each additional year of education, the infant mortality rate decreases by 7.1% (exp⁡(−0.071)−1exp(−0.071)−1).
- Life Expectancy: For each additional year of life expectancy, the infant mortality rate decreases by 8.4% (exp⁡(−0.084)−1exp(−0.084)−1).
- Income Class: Lower income classes are associated with higher infant mortality rates, with the coefficients representing the log of the multiplicative effect compared to the "H" (high-income) category.


## Conclusion

Both the GLM and log-transformed linear models are effective in characterizing the behavior of infant mortality rate. The GLM model shows a slightly better fit based on the AIC value, but both models highlight the significant negative relationships with years of education and life expectancy, and the influence of income class. The findings suggest that investing in education and healthcare could have positive effects on reducing infant mortality rates across different countries and income classifications. ​







Your report here.

# Wine data

```{r}
# Use janitor to clean the data
wine_clean <- Wine %>%
  clean_names() %>%
  remove_empty(c("rows", "cols"))

# Make year to be numeric
wine_clean$year <- as.numeric(wine_clean$year)

# check unique values in the year column
# unique(wine_clean$year)
```
```{r}
# remove the year column with "N.V." values
wine_clean_year <- wine_clean %>%
  filter(year != "N.V.")


```

```{r}
# Distribution of wine ratings
ggplot(data = wine_clean_year, aes(x=rating)) +
  geom_histogram(binwidth=0.1, fill="yellow", color="gray", alpha=0.7) +
  labs(title="Distribution of Wine Ratings", x="Rating", y="Frequency")
```
```{r}
ggplot(data = wine_clean_year,
       aes(x = rating, y = number_of_ratings, colour = variety)) + 
  geom_point(alpha = 0.5)
```


Distribution of Wine Ratings shows a normal distribution with a peak around 3.8. This indicates that most wines have ratings around 3.8, with fewer wines having higher or lower ratings.

```{r}
# Use qqplot to check the distribution of wine ratings
qqnorm(wine_clean_year$rating)
qqline(wine_clean_year$rating)
```

Given the histogram and qq-plot which has very minor skewness, a Gaussian distribution is an appropriate choice for GLM modelling.

```{r}
# Plot the relationship between rating and wine variety
ggplot(wine_clean_year, aes(x = variety, y = rating)) +
  geom_boxplot(color = "black", aes(fill = variety)) +
  scale_fill_manual(values = c("White" = "yellow", "Sparkling" = "orange", 
                               "Red" = "red", "Rose" = "magenta")) +
  labs(title = "Ratings by Wine Variety", x = "Variety", y = "Rating")
```

```{r, fig.width = 12, fig.height = 8}
# Rating by country
ggplot(wine_clean_year, aes(x = country, y = rating)) +
  geom_boxplot(color = "black", aes(fill = country)) +
  labs(title = "Ratings by Country", x = "Country", y = "Rating") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom")
```

```{r}
# Explore how rating correlate with price of wine
ggplot(data = wine_clean_year, aes(x=price, y=rating)) +
  geom_point(alpha=0.3) +
  scale_x_log10() +
  labs(title="Ratings vs. Price", x="Price (Euros)", y="Rating")
```

```{r, fig.width = 12, fig.height = 5}
# Explore the ratings over the years
ggplot(data = wine_clean_year, aes(x=year, y=rating, colour=variety)) +
  geom_point(alpha=0.8) +
  # geom_line() +
  geom_smooth(method="loess", se=FALSE, size = 1.5) +
  labs(title="Ratings over the Years", x="Year", y="Rating") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
```


## Regression models

The first model will be a simple linear model to find how price changes with the year for different varieties of wine.

$E(Price | Year, Variety) = \beta_0 + \beta_1 \times \text{Year} + \zeta_{\text{Red}} \times Variety_{Red} + \zeta_{\text{Rose}} \times Variety_{Rose} + \zeta_{\text{Sparkling}} \times Variety_{Sparkling} + \zeta_{\text{White}} \times Variety_{White}$

```{r, fig.width = 12, fig.height = 8}
# remove the outlier in "Sparkling" variety with year < 1980
wine_clean_year_special_case <- wine_clean_year %>%
  filter(!(variety == "Sparkling" & year < 1980)) 
```

```{r} 
# Linear regression model for 'Price' and 'Year' for different 'Varieties' with shared y-axis limits
ggplot(wine_clean_year_special_case, aes(x = year, y = price, color = variety)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, aes(colour = variety), formula = y ~ x) +
  facet_wrap(~ variety, scales = "free_x") +
  labs(title = "Linear Regression: Price vs. Year for Different Varieties",
       x = "Year",
       y = "Price") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  coord_cartesian(ylim = c(0, 300))

# Linear model for 'Price' and 'Year' for different 'Varieties'
lm_price_year_variety <- lm(price ~ year + variety - 1, data = wine_clean_year_special_case)
summary(lm_price_year_variety)

```


The second model will be a linear regression of 'Rating' on 'Price'. We use a logarithmic transformation on the price because of its skewed distribution.

$E(\text{Rating}) = \beta_0 + \beta_1 \times \log(\text{Price})$

```{r}
# Linear regression model
lm_wine <- lm(rating ~ log(price), data = wine_clean_year)
summary(lm_wine)
```

The linear regression model on 'Rating' using 'log(Price)' as a predictor can be expressed as

$E(\text{Rating}) = 3.131  + 0.249 \times \log(\text{Price})$

```{r}
# Generate predictions for the linear model
prediction_lm_wine <- predict(lm_wine)

ggplot(data = wine_clean_year, aes(x = rating, y = prediction_lm_wine)) +
  geom_point(alpha = 0.5) +
  # scale_x_log10() +
  # geom_abline(colour = "purple", size = 2, alpha = 0.4) +
  # geom_smooth(method = "lm", se = FALSE, colour = "blue") +
  geom_smooth(method = "loess", se = FALSE, colour = "red") +
  ggtitle("Linear Model Predictions vs. Actual") +
  xlab("Actual Rating") +
  ylab("Predicted Rating")
```

The plot shows the relationship between the actual and predicted ratings using the linear model. The red line represents the predicted values, which closely align with the actual data points. The LOESS model provides a good fit for the data, capturing the general trend of the relationship between price and rating.

Next, we consider a linear regression on 'Price' and 'NumberofRatings' as predictors of 'Rating'.

$E(\text{Rating}) = \beta_0 + \beta_1 \times \log(\text{Price}) + \beta_2 \times \log(\text{NumberofRatings})$

```{r}
# Linear regression model with Price and NumberofRatings as predictors
lm_wine_price_ratings <- lm(rating ~ log(price) + log(number_of_ratings), data = wine_clean_year)

summary(lm_wine_price_ratings)
```

The linear regression model on 'Rating' using 'log(Price)' and 'log(NumberofRatings)' as predictors can be expressed as

$E(\text{Rating}) = 3.044 + 0.248 \times \log(\text{Price}) + 0.018 \times \log(\text{NumberofRatings})$

```{r}
# Generate predictions for the linear model with Price and NumberofRatings as predictors
prediction_lm_wine_price_ratings <- predict(lm_wine_price_ratings)

ggplot(data = wine_clean_year, aes(x = rating, y = prediction_lm_wine_price_ratings)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE, colour = "red") +
  ggtitle("Linear Model with Price and Number of Ratings Predictions vs. Actual") +
  xlab("Actual Rating") +
  ylab("Predicted Rating")
```

```{r}
# Obtain the AIC values for the models
AIC(lm_wine, lm_wine_price_ratings)
```
Given the similarity in AIC values for the two models, the model with 'Price' and 'NumberofRatings' as predictors does not provide a significant improvement over the simpler model with only 'Price' as a predictor. The simpler model may be preferred due to its parsimony and similar predictive performance.

Therefore, the linear regression model with 'log(Price)' as a predictor provides a good fit for the data and captures the relationship between price and rating effectively.


GLM Gaussian Model:

Given our histograms in our EDA section showing a normal distribution of ratings, we can use a Gaussian GLM model to analyse the dataset.

We can either use a Gaussian GLM with identity link or log link. To determine, we check for AIC as well as plot the residuals.

```{r}
# Gaussian GLM with identity link
glm_model_1 <- glm(rating ~ log(price), data = wine_clean_year, family = gaussian(link = "identity"))
glm_model_2 <- glm(rating ~ log(price) + log(number_of_ratings), data = wine_clean_year, family = gaussian(link = "identity"))
glm_model_3 <- glm(rating ~ log(price), data = wine_clean_year, family = gaussian(link = "log"))
glm_model_4 <- glm(rating ~ log(price) + log(number_of_ratings), data = wine_clean_year, family = gaussian(link = "log"))

# Generate a table with AIC and R-squared values
kable(data.frame(Model = c("Identity Link, Rating | Log(Price)", "Identity Link, Rating | Log(Price), Log(NumberofRatings)", "Log Link, Rating | Log(Price)", "Log Link, Rating | Log(Price), Log(NumberofRatings)"),
                 AIC = c(AIC(glm_model_1), AIC(glm_model_2), AIC(glm_model_3), AIC(glm_model_4))))
```

```{r}
# Residuals plots for GLM Gaussian (Identity Link)
# Rating | Log(Price)
qqnorm(residuals(glm_model_1))
qqline(residuals(glm_model_1))
```

```{r}
# Residuals plots for GLM Gaussian (Identity Link)
# Rating | Log(Price), Log(NumberofRatings)
qqnorm(residuals(glm_model_2))
qqline(residuals(glm_model_2))
```

```{r}
# Residuals plots for GLM Gaussian (Log Link)
# Rating | Log(Price)
qqnorm(residuals(glm_model_3))
qqline(residuals(glm_model_3))
```

```{r}
# Residuals plots for GLM Gaussian (Log Link)
# Rating | Log(Price), Log(NumberofRatings)
qqnorm(residuals(glm_model_4))
qqline(residuals(glm_model_4))
```


From the QQ plots, we can see that the residuals in all 4 plots mostly fit the straight line with minor skewness. This suggests that the Gaussian GLM models are appropriate for the dataset. Thus, we use AIC to determine the preferred model.

From the AIC comparison, model 4 $(\text{Rating} | \log(\text{Price}), \log(\text{NumberofRatings})) = \beta_0 + \beta_1 \times \log(\text{Price}) + \beta_2 \times \log(\text{NumberofRatings})$ has the lowest AIC value, indicating that it is the preferred model.

```{r} 
# Generate predictions for the preferred GLM Gaussian model
prediction_glm_model_4 <- predict(glm_model_4)

ggplot(data = wine_clean_year, aes(x = rating, y = prediction_glm_model_4)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "loess", se = FALSE, colour = "red") +
  ggtitle("GLM Gaussian Model Predictions vs. Actual") +
  xlab("Actual Rating") +
  ylab("Predicted Rating")
```

The plot shows the relationship between the actual and predicted ratings using the preferred GLM Gaussian model. The red line represents the predicted values, which closely align with the actual data points. The LOESS model provides a good fit for the data, capturing the general trend of the relationship between price, number of ratings, and rating.

```{r}
# Using effects library to get the effect of log(price) and log(number_of_ratings)
eff_glm_model_4 <- allEffects(glm_model_4)
plot(eff_glm_model_4, main = "Effect of Log(Price) and Log(NumberofRatings) on Rating")
```




































# References

```{=html}
<!--
Include your references in this section. The ones below are just examples.
-->
```
1.  Wickham, H. *ggplot2: Elegant Graphics for Data Analysis* [on-line version](https://ggplot2-book.org/index.html)

2.  Wickham, H. & Grolemund, G. *R for Data Science.* [on-line version](https://r4ds.had.co.nz/index.html)

3.  https://www.graphpad.com/support/faq/testing-data-for-normal-distrbution/


```{r}
```

```{r}
# Check the structure of the data
str(sdg_clean)
```

```{r}
# Summarise the data
summary(sdg_clean)
```



```{r, fig.width = 12, fig.height = 12}
ggplot(data = sdg_clean, aes(x = years_education, y = infant_mortality_rate, colour = country)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") +
  labs(title = "Infant Mortality Rate by Years of Education", x = "Years of Education", y = "Infant Mortality Rate")
```

```{r, fig.width = 12, fig.height = 12}
glm_education_year_vs_infant_mortality_rate <- ggplot(
      data = sdg_clean,
      aes(x = years_education,
          y = infant_mortality_rate,
          colour = country)) +
      geom_point() +
      geom_smooth(
        method = "glm", 
        method.args = list(family = binomial(link="logit")), 
        formula = y ~ x, 
        se = FALSE, 
        linewidth = 0.5
      ) +
      theme(axis.text.x = element_text(angle = 90, hjust = 1), 
            legend.position = "bottom") +
      labs(title = "Infant Mortality Rate by Years of Education", 
           x = "Years of Education", 
           y = "Infant Mortality Rate")
glm_education_year_vs_infant_mortality_rate

# Infant Mortality Rate vs. Years of Education:
# 
#     There is a general downward trend suggesting that as the average years of education increases, the infant mortality rate tends to decrease.
#     The trend seems reasonably linear.
```

```{r, fig.width = 12, fig.height = 12}
ggplot(data = sdg_clean, aes(x = gdp, y = infant_mortality_rate, colour = country)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom") +
  labs(title = "Infant Mortality Rate by GDP", x = "GDP", y = "Infant Mortality Rate")

# Infant Mortality Rate vs. GDP per Capita:
# 
#     There is a significant downward trend indicating that higher GDP per capita correlates with lower infant mortality rates.
#     The trend is pronounced and suggests a potential exponential relationship.
```

```{r, fig.width = 12, fig.height = 12}
ggplot(data = sdg_clean, aes(x = life_expectancy, y = infant_mortality_rate, colour = country)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") +
  labs(title = "Infant Mortality Rate by Life Expectancy", x = "Life Expectancy", y = "Infant Mortality Rate")

# Infant Mortality Rate vs. Life Expectancy:
# 
#     There is a clear downward trend indicating that countries with higher life expectancy generally have lower infant mortality rates.
#     The trend looks linear, though with some variability.
```

```{r, fig.width = 12, fig.height = 12}
ggplot(data = sdg_clean, aes(x = year, y = income_class, colour = country)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") +
  labs(title = "Income Class by Year", x = "Year", y = "Income Class")
```

```{r, fig.width = 12, fig.height = 12}
ggplot(data = sdg_clean, aes(x = year, y = income_class, colour = country)) +
  geom_point() +
  # geom_smooth() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom") +
  labs(title = "Income Class by Year", x = "Year", y = "Income Class")
```

```{r}
# Model 1: Linear Regression for Infant Mortality Rate vs. Years of Education
model_education_year_vs_infant_mortality_rate <- lm(infant_mortality_rate ~ years_education, data = sdg_clean)
summary(model_education_year_vs_infant_mortality_rate)
```

```{r}
# Model 2: Log-Transformed Linear Regression (Infant Mortality Rate vs. GDP per Capita)
model_gdp_vs_infant_mortality_rate <- lm(log(infant_mortality_rate) ~ log(gdp), data = sdg_clean)
summary(model_gdp_vs_infant_mortality_rate)
```

```{r}
# Model 3: Linear Regression for Infant Mortality Rate vs. Life Expectancy
model_life_expectancy_vs_infant_mortality_rate <- lm(infant_mortality_rate ~ life_expectancy, data = sdg_clean)
summary(model_life_expectancy_vs_infant_mortality_rate)
```

```{r}
# Create plots for the models
ggplot(data = sdg_clean, aes(x = years_education, y = infant_mortality_rate)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Infant Mortality Rate vs. Years of Education", x = "Years of Education", y = "Infant Mortality Rate")
```

```{r}
ggplot(data = sdg_clean, aes(x = log(gdp), y = log(infant_mortality_rate))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Infant Mortality Rate vs. GDP per Capita", x = "Log(GDP)", y = "Log(Infant Mortality Rate)")

# The first effect plot showcases the relationship between infant_mortality_rate and gdp using Model 2. The plot is on a log scale, and it reveals a strong negative correlation between GDP per capita and infant mortality rate. The red line illustrates the model's predicted values, closely fitting the actual data points.
# Model 2: Log-Transformed Linear Regression for infant_mortality_rate vs. gdp
# 
#     The conditional expectation: E[log⁡(Y)∣X]=4.3785−0.5962⋅log⁡(gdp)E[log(Y)∣X]=4.3785−0.5962⋅log(gdp)
#     This model provides a strong fit with an R2R2 of 0.777 and the lowest AIC value of 394.6.
#     This suggests that an exponential decay in infant mortality rate is associated with increasing GDP.
```

```{r}
ggplot(data = sdg_clean, aes(x = life_expectancy, y = infant_mortality_rate)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Infant Mortality Rate vs. Life Expectancy", x = "Life Expectancy", y = "Infant Mortality Rate")

#The second effect plot demonstrates the relationship between infant_mortality_rate and life_expectancy using Model 3. The negative correlation is evident, with the red line depicting the predicted values. The model aligns well with the data points, showing that higher life expectancy generally corresponds to lower infant mortality rates.
# Model 3: Linear Regression for infant_mortality_rate vs. life_expectancy
# 
#     The conditional expectation: E[Y∣X]=176.7136−2.1573⋅life_expectancyE[Y∣X]=176.7136−2.1573⋅life_expectancy
#     This model provides a strong fit with an R2R2 of 0.783 and a low AIC value of 1708.0.
#     This suggests that higher life expectancy generally corresponds to lower infant mortality rates.

```

```{r}
# GPT conclusions for model 2 and 3
# Both models indicate strong negative relationships between infant mortality rates and the respective predictors (gdp and life_expectancy). The models highlight the influence of socio-economic and health-related factors on infant mortality. The GDP-based model showcases the impact of economic conditions, while the life expectancy model highlights the impact of health and quality of life on infant mortality.
```


```{r}
# write_csv(wine_clean_year, here("data", "wine_clean_year.csv"))
# write_csv(sdg_clean, here("data", "sdg_clean.csv"))
# write_csv(wine_clean, here("data", "wine_clean.csv"))
```

\`\`\`{r}
