---
title: 'MA50258: Applied Statistics'
subtitle: 'Coursework  1'
author: "09618"
output:
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
---

```{r knit options, include=FALSE}
# knitting options here
knitr::opts_chunk$set(echo = TRUE, highlight = TRUE,warning = FALSE,message= FALSE)
```

```{r packages}
# indicate all your loaded packages here
library(tidyverse) 
library(readr)
library(here)

# Other loaded packages
library(lubridate)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(viridis) # Increase the number of colours available
```

```{r data-load}
formula_tom <- read_csv(here("data", "formula_tom.csv"))
```

## Question 1

The lap time variables (`q1`, `q2`, `q3` and `fastest_lap`) require conversion into a usable format, note the times in the raw data are recorded in minutes and seconds (where seconds are shown to three decimal places). Convert the times to seconds.

```{r,message=FALSE}
# To convert a variable q1 into minutes and seconds format we use ms()
func_convert_time_to_seconds <- function(raw_time) {
  # Check for NA or \N values and return NA for all
  if (is.na(raw_time) || raw_time == "\\N") {
    return(NA)
  }
  else {
    return(as.numeric(ms(raw_time)))
  }
}

q1_in_seconds <- sapply(formula_tom$q1, func_convert_time_to_seconds)
q2_in_seconds <- sapply(formula_tom$q2, func_convert_time_to_seconds)
q3_in_seconds <- sapply(formula_tom$q3, func_convert_time_to_seconds)
fastest_lap_in_seconds <- sapply(formula_tom$fastest_lap, func_convert_time_to_seconds)

# Adding the converted times back to the original data frame
formula_tom$q1_in_seconds <- q1_in_seconds
formula_tom$q2_in_seconds <- q2_in_seconds
formula_tom$q3_in_seconds <- q3_in_seconds
formula_tom$fastest_lap_in_seconds <- fastest_lap_in_seconds
```

## Question 2

Summarise the four lap time variables (`q1`, `q2`, `q3` and `fastest_lap`) giving minimums, means, medians and maximums.

```{r,message=FALSE}
# Function to calculate the required statistics
func_get_summary_stats <- function(x) {
  c(Minimum = min(x, na.rm = TRUE), 
    Mean = mean(x, na.rm = TRUE), 
    Median = median(x, na.rm = TRUE), 
    Maximum = max(x, na.rm = TRUE))
}

# Calculate summaries
summary_q1 <- func_get_summary_stats(q1_in_seconds)
summary_q2 <- func_get_summary_stats(q2_in_seconds)
summary_q3 <- func_get_summary_stats(q3_in_seconds)
summary_fastest_lap <- func_get_summary_stats(fastest_lap_in_seconds)

# Combine into a data frame
summary_df <- data.frame(
  Q1 = summary_q1,
  Q2 = summary_q2,
  Q3 = summary_q3,
  Fastest_Lap = summary_fastest_lap
)

# Use kable for a nice table format
kable(
  summary_df,
      caption = "Summary of Fastest Lap Times of Each Competitor",
      digits = 2,
      align = "c",
      col.names = c(
        "From 1st Qualifying Session",
        "From 2nd Qualifying Session",
        "From 3rd Qualifying Session",
        "Set Over The Race")
      ) %>%
  kable_styling("striped", full_width = F, position = "c")
```

What conclusions can you draw from your summaries?

------------------------------------------------------------------------

<u> Answer </u>

The summary statistics for the four lap time variables are presented in the table above. The minimum, mean, median and maximum times are calculated for each of the four variables.

------------------------------------------------------------------------

## Question 3

Produce a scatter plot of `q1` against `q3`. In the same plot, add an overlay of the fit of the corresponding LOESS fit as well as the fit of the following linear regression model:

$$E[\verb|q3||\verb|q1|]=\alpha_0 + \alpha_1 \,\verb|q1|$$

```{r, message=FALSE}
# EDA Code
ggplot(
  formula_tom,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
    subtitle = "Excluding an extreme outlier"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
# Filtering out an extreme outlier (datum no. 2568 that has a lap time of 16min), this is done by setting a threshold of 180 seconds filter
formula_tom_q1_outlier_filtered <- formula_tom %>% filter(q1_in_seconds < 180)
ggplot(
  formula_tom_q1_outlier_filtered,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
    subtitle = "Excluding an extreme outlier"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
formula_tom_q1_extreme_filtering  <- formula_tom %>% filter(q1_in_seconds < 135)
ggplot(
  formula_tom_q1_extreme_filtering,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 Against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
    subtitle = "Extreme filtering"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
unfitted_data_points <- formula_tom %>% filter(q1_in_seconds > 135) %>% select(q1_in_seconds, q3_in_seconds)
kable(
  unfitted_data_points,
  caption = "Checking Unfitted Data Points",
  digits = 2,
  align = "c",
) %>%
  kable_styling("striped", full_width = F, position = "c")
```

What can you say about each fit, is there any agreement between them?

------------------------------------------------------------------------

# TODO

<ul>Answer</ul>

```{r,message=FALSE}
# The reason why there are some data points that aren't being shown is due to presence of missing data
# Redoing the scatter plot and excluding data points with missing data
formula_tom_no_na_q3 <- formula_tom %>% drop_na(q1_in_seconds, q3_in_seconds) %>% filter(q1_in_seconds < 180)

ggplot(formula_tom_no_na_q3, aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = FALSE, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = FALSE, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 Against q3 with LOESS and Linear Model Fits",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data and an extreme outlier"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

------------------------------------------------------------------------

## Question 4

Fit the LOESS empirical estimate (joint with interaction) of the regression function $s$ in the model:

$$E[\verb|q3||\verb|q1|,\verb|championship_points|]=s(\verb|q1|,log_{10}(\verb|championship_points|))$$

also, fit the following linear regression model:

$$
\begin{multline}
e[\verb|q3||\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$

```{r}
# EDA Code
# Check for relationship between q1 and championship_points
formula_eda_q4 <- formula_tom %>% drop_na(championship_points, q1_in_seconds, q3_in_seconds) %>%  filter(q1_in_seconds < 180)
log10_championship_points <- log10(formula_eda_q4$championship_points + 1)
ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = championship_points)) +
  geom_point(alpha = 0.25) +
  # geom_smooth(aes(col = "loess smoothing"), method = "loess", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against q1 with Championship Points (Non Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data and an extreme outlier"
  ) + 
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(formula_eda_q4$championship_points)/2, na.rm = TRUE)
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))


ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  geom_point(alpha = 0.25) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) + 
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(log10_championship_points)/2, na.rm = TRUE)
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))

# Include the deciles (Breaking up log10_championship_points into deciles)
formula_eda_q4_break_points <- formula_eda_q4 %>%
  mutate(decile = cut(log10_championship_points,
                      breaks = quantile(log10_championship_points,
                                        probs = seq(0, 1, by = 0.1)),
                      include.lowest = TRUE,
                      labels = paste0(seq(10, 100, by = 10), "%")))  # Label the deciles

ggplot(
  formula_eda_q4_break_points,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  geom_point(alpha = 0.25) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) +
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(log10_championship_points)/2, na.rm = TRUE)
  ) +
  facet_wrap(~decile, scales = "free", ncol = 4)
```

```{r}
# EDA Code
# Fit the linear model with interaction
formula_tom_no_na_q4 <- formula_tom %>% drop_na(q1_in_seconds, q3_in_seconds, championship_points) # %>% filter(q1_in_seconds < 180)

# Add +1 to avoid log(0) error
formula_tom_no_na_q4_log10_championship_points <- log10(formula_tom_no_na_q4$championship_points + 1)

ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
      y = q3_in_seconds)) +
  geom_point(alpha = 0.25) 

# Make x-axis to be the log-transformed championship points
ggplot(
  formula_tom_no_na_q4,
  aes(x = log10_championship_points,
      y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against log10(championship_points)",
    x = "log10(championship_points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))
```

```{r}
# EDA Code
# Fit the linear model with interaction
lm_model_q4 <- lm(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

# Create the table
kable(
  summary(lm_model_q4)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")
```

```{r}
# Fit the LOESS model with interaction
loess_model_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)
loess_model_without_interaction_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

# Create the table
summary(loess_model_q4)
```

```{r}
library(modelr) # For using add_prediction and data_grid functions
mid_decile_points <- quantile(formula_tom_no_na_q4_log10_championship_points, probs = seq(0.05, 0.95, by = 0.1))
mid_decile_points <- signif(mid_decile_points, digits = 3)
kable(mid_decile_points, caption = "Mid-Decile Points", align = "c")

# Add the decile information with interaction to formula_tom_no_na_q4 dataframe
pred_grid <- 
  formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(loess_model_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

# Add the decile information without interaction to formula_tom_no_na_q4 dataframe
pred_grid_without_interaction <- 
  formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(loess_model_without_interaction_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

# With interaction
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  )

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom")

# Without interaction
formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid_without_interaction) +
    theme(legend.position = "bottom")

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid_without_interaction) +
    theme(legend.position = "bottom")

# Zoom in to certain dense regions
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom")

formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(60, 70) +
    ylim(60, 75)

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(70, 80) +
    ylim(60, 110)

formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(80, 90) +
    ylim(60, 110)

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(90, 100) +
    ylim(60, 130)

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(100, 110) +
    ylim(70, 130)

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(110, 120) +
    ylim(70, 130)

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
    xlim(120, 130) +
    ylim(70, 130)
```

For both the linear model and the LOESS model:

-   Plot the effect of `championship_points` on `q3`.

-   Plot the effect of `q1` on `q3` for mid-deciles (eg percentiles of order 5%, 15%, 25%, …, 95%) of `championship_points.`

```{r}
# Plot the effect of championship points on q3
ggplot(
  formula_tom_no_na_q4,
  aes(x = log10_championship_points,
      y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against log10(championship_points)",
    x = "log10(championship_points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))

# Fit the linear model with interaction
lm_model_q4 <- lm(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

# Create the table
kable(
  summary(lm_model_q4)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")


loess_model_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)
loess_model_without_interaction_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

# Create the table
# TODO: Tidy up the loess output
summary(loess_model_q4)


pred_grid_lm <-  formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(lm_model_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

pred_grid_loess <-   formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(loess_model_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

# LM plot: The effect of championship points on q3 with championship points' mid-deciles
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_lm) +
  labs(
    title = "q3 Against log10(championship_points)",
    x = "log10(championship_points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  )
  
# LOESS plot: The effect of q1 on q3 with championship points' mid-deciles
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_loess) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  )
```

Interpret both effect plots and comment on the fit the transformed linear model to the data. Also, give an interpretation of the estimated parameters in this model (apart from the intercept).

------------------------------------------------------------------------

<ul>Answer</ul>

------------------------------------------------------------------------

## Question 5

The original data contains missing values for `q3`, some due to the current structure of a qualifying session some due to changes in rules for qualifying. Using the models from Question 4 predict the missing values. If you now produce the same summaries as you did in Question 1 what impact has this ha

```{r}
# Your code answer here
# Update the missing_q3_data to include all necessary variables for the model
missing_q3_data <- formula_tom %>%
  mutate(
    log10_championship_points = log10(championship_points + 1),
    q1_in_seconds = q1_in_seconds,  # assuming this variable is already correct in your dataset
    interaction_term = q1_in_seconds * log10(championship_points + 1)  # create interaction term as per model
  ) %>% 
  filter(is.na(q3_in_seconds)) %>%  # filter only missing q3_in_second %>% s
  filter(!is.na(interaction_term)) %>%  # filter only missing interaction term))
  select(q1_in_seconds, q3_in_seconds, log10_championship_points, interaction_term)

# Rename the columns in missing_q3_data to match the model's names
names(missing_q3_data) <- c("q1_in_seconds", "q3_in_seconds", "formula_tom_no_na_q4_log10_championship_points", "interaction_term")

# Predict q3_in_seconds using the linear model
missing_q3_data$predicted_q3_lm <- predict(lm_model_q4, newdata = missing_q3_data)

# Predict q3_in_seconds using the loess model
missing_q3_data$predicted_q3_loess <- predict(loess_model_q4, newdata = missing_q3_data)

# Summary of the predicted q3_in_seconds
# Missing data in LOESS model
kable(
  missing_q3_data %>% 
    select(q3_in_seconds, predicted_q3_lm, predicted_q3_loess) %>% 
    summary(),
  caption = "Summary of the Predicted q3_in_seconds",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")
```

```{r}
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_lm) +
  labs(
    title = "q3 Against log10(championship_points)",
    x = "log10(championship_points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) 
```

```{r}
ggplot() +
  geom_point(data = formula_tom_no_na_q4, aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data, aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  geom_point(data = missing_q3_data, aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LM Predictions (red), LOESS Predictions (blue)"
  )
```

```{r}
# Filter out the extreme outlier
ggplot() +
  geom_point(data = formula_tom_no_na_q4 %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LM Predictions (red), LOESS Predictions (blue)"
  )
```

```{r}
# Overlay with LM prediction
ggplot() +
  geom_point(data = formula_tom_no_na_q4 %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LM Predictions (red)"
  )
```

```{r}
# Overlay with LOESS prediction
ggplot() +
  geom_point(data = formula_tom_no_na_q4 %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LOESS Predictions (blue)"
  )
```

```{r}
# Overlay LM and LOESS predictions
ggplot() +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of LM and LOESS Predictions",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "LM Predictions (red), LOESS Predictions (blue)"
  )
```

```{r}
```

## Question 6

Create a new variable `qmin` that gives the minimum time each competitor set across `q1`, `q2` and `q3`. Produce a scatterplot of `q1`against `qmin`, fitting a suitable model to these data.

```{r,message=FALSE}
# Your code answer here
formula_tom_q6 <- formula_tom %>% select(q1_in_seconds, q2_in_seconds, q3_in_seconds) %>%
  drop_na(q1_in_seconds, q2_in_seconds, q3_in_seconds) %>%
  mutate(qmin = pmin(q1_in_seconds, q2_in_seconds, q3_in_seconds, na.rm = TRUE))

ggplot(
  formula_tom_q6,
  aes(x = q1_in_seconds,
      y = qmin)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "qmin Against q1",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Minimum Fastest Lap Time Across q1, q2, and q3 (qmin)",
    subtitle = "Excluded missing data"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))
```

What model have you fitted, what conclusions can you draw?

## Question 7

Produce a scatterplot of `q1` and `fastest_lap`, write down and then fit a linear regression model that could be fitted to these data.

$$Your theory answer here$$

```{r,message=FALSE}
# Convert fastest_lap to seconds


formula_tom_q7 <- formula_tom %>%
  select(q1_in_seconds, fastest_lap_in_seconds) %>%
  drop_na(q1_in_seconds, fastest_lap_in_seconds) %>% 
  filter(q1_in_seconds < 180)  # Filtering out the 16min outlier)

# TODO: Do I need to manually define a lm model and plot it separately

ggplot(
  formula_tom_q7,
  aes(x = q1_in_seconds,
      y = fastest_lap_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F) +
  labs(
    title = "Fastest Lap Against q1",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time",
    subtitle = "Excluded an outlier data"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("Linear Model Fit" = "blue"))
```

```{r}
```

Which of these times would you expect to be faster based on this model? (Hint you may wish to examine the parameter estimates of the linear model).

## Question 8

For your plot produced in Question 7 add the corresponding LOESS fit. Does this change the conclusions?

```{r,message=FALSE}
# Your code answer here
ggplot(
  formula_tom_q7,
  aes(x = q1_in_seconds,
      y = fastest_lap_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Fastest Lap Against q1",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time",
    subtitle = "Excluded an outlier data"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))
```

## Question 9

Now we consider the impact of qualifying time (in particular `q1`) on `race_time`. Fit and compare the linear regression model $$
\begin{multline}
E[\verb|race_time||\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$ with the generalised additive model fitting the regression function (including an interaction of the explanatory variables).

$$
E[\verb|race_time||\verb|q1|,log_{10}(\verb|championship_points|)]= s(\verb|q1|,log_{10}(\verb|championship_points|))
$$

```{r,message=FALSE}
library(mgcv)

formula_tom_q9 <- formula_tom %>%
  drop_na(q1_in_seconds, championship_points, race_time) %>%
  filter(q1_in_seconds < 180) %>%  # Filtering out the 16min outlier
  mutate(
    log10_championship_points = log10(championship_points + 1)
  ) %>%
  select(q1_in_seconds, log10_championship_points, race_time)

# Fit the linear regression model with interaction
lm_model_q9 <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = formula_tom_q9)

# Fit the generalised additive model with interaction
gam_model_q9 <- gam(race_time ~ s(q1_in_seconds, log10_championship_points), data = formula_tom_q9)

# Create the table
kable(
  summary(lm_model_q9)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")

# TODO kable for gam_model_q9
summary(gam_model_q9)
```

```{r}
ggplot(
  formula_tom_q9,
  aes(x = q1_in_seconds,
      y = race_time)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "GAM Model Fit"), method = "gam", se = F, linewidth = 0.5) +
  labs(
    title = "Effect of q1 and Championship Points on Race Time",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Race Time"
) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("Linear Model Fit" = "blue", "GAM Model Fit" = "red"))

```
```{r}
mid_decile_points_q9 <- quantile(formula_tom_q9$log10_championship_points, probs = seq(0.05, 0.95, by = 0.1))
mid_decile_points_q9 <- signif(mid_decile_points, digits = 3)
kable(mid_decile_points_q9, caption = "Mid-Decile Points", align = "c")

pred_grid_q9_lm <-  formula_tom_q9 %>%
  data_grid(
    log10_championship_points = mid_decile_points_q9,
    q1_in_seconds = seq(min(formula_tom_q9$q1_in_seconds), max(formula_tom_q9$q1_in_seconds))) %>%
  add_predictions(
    lm_model_q9,
    var = "race_time",
    type = "response"
  ) %>% 
  mutate(
    log10_championship_points = factor(log10_championship_points)
  )

pred_grid_q9_gam <-  formula_tom_q9 %>%
  data_grid(
    log10_championship_points = mid_decile_points_q9,
    q1_in_seconds = seq(min(formula_tom_q9$q1_in_seconds), max(formula_tom_q9$q1_in_seconds))) %>%
  add_predictions(
    gam_model_q9,
    var = "race_time",
    type = "response"
  ) %>% 
  mutate(
    log10_championship_points = factor(log10_championship_points)
  )

# Plot for LM with interaction
formula_tom_q9 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = race_time,
                  col = log10_championship_points),
              data = pred_grid_q9_lm)

# Plot for GAM with interaction
formula_tom_q9 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = race_time,
                  col = log10_championship_points),
              data = pred_grid_q9_gam)
```

  
## Question 10

Suppose we modify the linear model used in Question 9 such that we fit $$
\begin{multline}
E[log_{10}(\verb|race_time|)|\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$ Discuss how this would modify the interpretation of model.

```{r}
formula_tom_q10 <- formula_tom %>%
  drop_na(q1_in_seconds, championship_points, race_time) %>%
  # filter(q1_in_seconds < 180) %>%  # Filtering out the 16min outlier
  mutate(
    log10_championship_points = log10(championship_points + 1),
    log10_race_time = log10(race_time)
  ) %>%
  select(q1_in_seconds, log10_championship_points, log10_race_time)

# Fit the linear regression model with interaction
lm_model_q10 <- lm(log10_race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = formula_tom_q10)

mid_decile_points_q10 <- quantile(formula_tom_q10$log10_championship_points, probs = seq(0.05, 0.95, by = 0.1))
mid_decile_points_q10 <- signif(mid_decile_points, digits = 3)
kable(mid_decile_points_q10, caption = "Mid-Decile Points", align = "c")

pred_grid_q10_lm <-  formula_tom_q10 %>%
  data_grid(
    log10_championship_points = mid_decile_points_q10,
    q1_in_seconds = seq(min(formula_tom_q10$q1_in_seconds), max(formula_tom_q10$q1_in_seconds))) %>%
  add_predictions(
    lm_model_q10,
    var = "log10_race_time",
    type = "response"
  ) %>% 
  mutate(
    log10_championship_points = factor(log10_championship_points)
  )

# Plot for LM with interaction
formula_tom_q10 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = log10_race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = log10_race_time,
                  col = log10_championship_points),
              data = pred_grid_q10_lm)

formula_tom_q10 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = log10_race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = log10_race_time,
                  col = log10_championship_points),
              data = pred_grid_q10_lm) +
  ylim(3.5, 4.25) # Filter out the outlier concentration
```

## Question 11

Suppose someone wishes for you to investigate the effect of `circuit_Id` why might this be problematic?

```{r, fig.height=150, fig.width=8}
formula_tom_q11 <- formula_tom %>%
  drop_na(q1_in_seconds, circuit_ID, race_time, championship_points) %>%
  mutate(
    log10_championship_points = log10(championship_points + 1)
  ) %>%
  select(q1_in_seconds, circuit_ID, race_time, championship_points)

# ggplot(
#   formula_tom_q11,
#   aes(x = q1_in_seconds,
#       y = q3_in_seconds, col = circuit_ID)) +
#   geom_point(alpha = 0.25) +
#   theme(legend.position = "bottom") + facet_wrap(~circuit_ID, ncol = 3)
ggplot(formula_tom_q11, aes(x = q1_in_seconds, y = race_time, col = circuit_ID)) +
  geom_point(alpha = 0.25) +
  theme(legend.position = "bottom") +
  facet_wrap(~circuit_ID, ncol = 1) +
  theme(
    strip.text.x = element_text(size = 7), # Adjust size as needed
    axis.text.x = element_text(angle = 45, hjust = 1) # Angle x axis text for space
  ) +
  labs(
    title = "Lap Times by Circuit",
    x = "Q1 Time in Seconds",
    y = "Q3 Time in Seconds",
    colour = "Circuit ID"
  ) +
  guides(col = guide_legend(ncol = 3)) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

## Question 12

Choosing a subset of 5 observations of `circuit_Id` investigate the impact of `circuit_Id` by incorporating it into your linear model from Question 9.

```{r,message=FALSE}
# Select the top 5 circuits with the most observations
circuit_counts <- formula_tom_q11 %>%
  count(circuit_ID) %>%
  arrange(desc(n)) %>%
  slice(1:5) # Get the top 5

kable(circuit_counts, caption = "Top 5 Circuits with the Most Observations", align = "c", col.names = c("Circuit ID", "Number of Observations"))

```

```{r}
formula_tom_q12 <- formula_tom %>%
  drop_na(q1_in_seconds, championship_points, race_time) %>%
  filter(circuit_ID %in% circuit_counts$circuit_ID) %>%
  mutate(
    log10_championship_points = log10(championship_points + 1)) %>%
  select(q1_in_seconds, log10_championship_points, circuit_ID, race_time)

# Fit the linear regression model with interaction
lm_model_q12 <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points + circuit_ID, data = formula_tom_q12)

# Create the lm table
kable(
  summary(lm_model_q12)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")

# Fit the generalised additive model with interaction
gam_model_q12 <- gam(race_time ~ s(q1_in_seconds, log10_championship_points) + circuit_ID, data = formula_tom_q12)

# Create the gam table
summary(gam_model_q12)
```


```{r}
circuit_id_colors <- viridis::viridis(n = length(circuit_id_levels), option = "C")

# Your ggplot call
ggplot(formula_tom_q12, aes(x = q1_in_seconds, y = race_time)) +
  geom_point(aes(color = circuit_ID), alpha = 0.25) +
  geom_smooth(method = "lm", se = FALSE, color = "red", size = 0.8) +
  geom_smooth(method = "gam", se = FALSE, color = "blue", size = 0.8) +
  labs(
    title = "Effect of q1 and Championship Points",
    x = "Fastest Lap Time From The 1st Qualifying Session",
    y = "Race Time",
    subtitle = "Excluded missing data",
    color = "Circuit ID"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(values = circuit_id_colors) +
  guides(col = guide_legend(ncol = 3)) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

What do you conclude about the impact of circuit?

