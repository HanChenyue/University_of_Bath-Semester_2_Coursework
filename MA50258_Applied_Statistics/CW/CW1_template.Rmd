---
title: 'MA50258: Applied Statistics'
subtitle: 'Coursework  1'
author: "09618"
output:
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
---

```{r knit options, include=FALSE}
# knitting options here
knitr::opts_chunk$set(echo = TRUE, highlight = TRUE,warning = FALSE,message= FALSE)
```

```{r packages}
# indicate all your loaded packages here
library(tidyverse) 
library(readr)
library(here)

# Other loaded packages
library(lubridate)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(patchwork)
```

```{r data-load}
formula_tom <- read_csv(here("data", "formula_tom.csv"))
```

## Question 1

The lap time variables (`q1`, `q2`, `q3` and `fastest_lap`) require conversion into a usable format, note the times in the raw data are recorded in minutes and seconds (where seconds are shown to three decimal places). Convert the times to seconds.

```{r,message=FALSE}
# To convert a variable q1 into minutes and seconds format we use ms()
func_convert_time_to_seconds <- function(raw_time) {
  # Check for NA or \N values and return NA for all
  if (is.na(raw_time) || raw_time == "\\N") {
    return(NA)
  }
  else {
    return(as.numeric(ms(raw_time)))
  }
}

q1_in_seconds <- sapply(formula_tom$q1, func_convert_time_to_seconds)
q2_in_seconds <- sapply(formula_tom$q2, func_convert_time_to_seconds)
q3_in_seconds <- sapply(formula_tom$q3, func_convert_time_to_seconds)
fastest_lap_in_seconds <- sapply(formula_tom$fastest_lap, func_convert_time_to_seconds)

# Adding the converted times back to the original data frame
formula_tom$q1_in_seconds <- q1_in_seconds
formula_tom$q2_in_seconds <- q2_in_seconds
formula_tom$q3_in_seconds <- q3_in_seconds
formula_tom$fastest_lap_in_seconds <- fastest_lap_in_seconds
```

## Question 2

Summarise the four lap time variables (`q1`, `q2`, `q3` and `fastest_lap`) giving minimums, means, medians and maximums.

```{r,message=FALSE}
# Function to calculate the required statistics
func_get_summary_stats <- function(x) {
  c(Minimum = min(x, na.rm = TRUE), 
    Mean = mean(x, na.rm = TRUE), 
    Median = median(x, na.rm = TRUE), 
    Maximum = max(x, na.rm = TRUE))
}

# Calculate summaries
summary_q1 <- func_get_summary_stats(q1_in_seconds)
summary_q2 <- func_get_summary_stats(q2_in_seconds)
summary_q3 <- func_get_summary_stats(q3_in_seconds)
summary_fastest_lap <- func_get_summary_stats(fastest_lap_in_seconds)

# Combine into a data frame
summary_df <- data.frame(
  Q1 = summary_q1,
  Q2 = summary_q2,
  Q3 = summary_q3,
  Fastest_Lap = summary_fastest_lap
)

# Use kable for a nice table format
kable(
  summary_df,
      caption = "Summary of Fastest Lap Times of Each Competitor",
      digits = 2,
      align = "c",
      col.names = c(
        "From 1st Qualifying Session",
        "From 2nd Qualifying Session",
        "From 3rd Qualifying Session",
        "Set Over The Race")
      ) %>%
  kable_styling("striped", full_width = F, position = "c")
```

What conclusions can you draw from your summaries?

---

<u> Answer </u>

The summary statistics for the four lap time variables are presented in the table above. The minimum, mean, median and maximum times are calculated for each of the four variables.

---

## Question 3

Produce a scatter plot of `q1` against `q3`. In the same plot, add an overlay of the fit of the corresponding LOESS fit as well as the fit of the following linear regression model:

$$E[\verb|q3||\verb|q1|]=\alpha_0 + \alpha_1 \,\verb|q1|$$
```{r, message=FALSE}
# EDA Code
ggplot(
  formula_tom,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
    subtitle = "Excluding an extreme outlier"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
# Filtering out an extreme outlier (datum no. 2568 that has a lap time of 16min), this is done by setting a threshold of 180 seconds filter
formula_tom_q1_outlier_filtered <- formula_tom %>% filter(q1_in_seconds < 180)
ggplot(
  formula_tom_q1_outlier_filtered,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
    subtitle = "Excluding an extreme outlier"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```
```{r, message=FALSE}
# EDA Code
formula_tom_q1_extreme_filtering  <- formula_tom %>% filter(q1_in_seconds < 135)
ggplot(
  formula_tom_q1_extreme_filtering,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 Against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
    subtitle = "Extreme filtering"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
unfitted_data_points <- formula_tom %>% filter(q1_in_seconds > 135) %>% select(q1_in_seconds, q3_in_seconds)
kable(
  unfitted_data_points,
  caption = "Checking Unfitted Data Points",
  digits = 2,
  align = "c",
) %>%
  kable_styling("striped", full_width = F, position = "c")
```


What can you say about each fit, is there any agreement between them?

---

# TODO
<ul>Answer</ul>

```{r,message=FALSE}
# The reason why there are some data points that aren't being shown is due to presence of missing data
# Redoing the scatter plot and excluding data points with missing data
formula_tom_no_na_q3 <- formula_tom %>% drop_na(q1_in_seconds, q3_in_seconds) %>% filter(q1_in_seconds < 180)

ggplot(formula_tom_no_na_q3, aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = FALSE, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = FALSE, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 Against q3 with LOESS and Linear Model Fits",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data and an extreme outlier"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```


---

## Question 4

Fit the LOESS empirical estimate (joint with interaction) of the regression function $s$ in the model:

$$E[\verb|q3||\verb|q1|,\verb|championship_points|]=s(\verb|q1|,log_{10}(\verb|championship_points|))$$
```{r}
# EDA Code
# Check for relationship between q1 and championship_points
formula_eda_q4 <- formula_tom %>% drop_na(championship_points, q1_in_seconds, q3_in_seconds) %>%  filter(q1_in_seconds < 180)
log10_championship_points <- log10(formula_eda_q4$championship_points + 1)
ggplot(
  formula_eda_q4,
  # aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  aes(x = q1_in_seconds, y = q3_in_seconds, col = championship_points)) +
  geom_point(alpha = 0.25) +
  # geom_smooth(aes(col = "loess smoothing"), method = "loess", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against q1 with Championship Points (Non Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data and an extreme outlier"
  ) + 
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(formula_eda_q4$championship_points)/2, na.rm = TRUE)
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))


ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  geom_point(alpha = 0.25) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) + 
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(log10_championship_points)/2, na.rm = TRUE)
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))

# Include the deciles (Breaking up log10_championship_points into deciles)
formula_eda_q4_break_points <- formula_eda_q4 %>%
  mutate(decile = cut(log10_championship_points,
                      breaks = quantile(log10_championship_points,
                                        probs = seq(0, 1, by = 0.1)),
                      include.lowest = TRUE,
                      labels = paste0(seq(10, 100, by = 10), "%")))  # Label the deciles

ggplot(
  formula_eda_q4_break_points,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  geom_point(alpha = 0.25) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    subtitle = "Excluded missing data"
  ) +
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(log10_championship_points)/2, na.rm = TRUE)
  ) +
  facet_wrap(~decile, scales = "free", ncol = 4)
```

```{r}
# EDA Code
# Fit the linear model with interaction
formula_tom_no_na_q4 <- formula_tom %>% drop_na(q1_in_seconds, q3_in_seconds, championship_points) # %>% filter(q1_in_seconds < 180)
lm_model_q4 <- lm(q3_in_seconds ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = formula_tom_no_na_q4)

# Fit the LOESS model with interaction
loess_model_q4 <- loess(q3_in_seconds ~ q1_in_seconds + log10_championship_points, data = formula_tom_no_na_q4)
```

```{r}
# Add a new column for the decile groups
formula_tom_no_na_q4 <- formula_tom_no_na_q4 %>%
  mutate(
    decile_group = cut(log10_championship_points, 
                       breaks = quantile(log10_championship_points, probs = seq(0, 1, by = 0.1)),
                       include.lowest = TRUE, 
                       labels = FALSE)
  )

# Plotting the LOESS fit for each decile
ggplot(formula_tom_no_na_q4, aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(aes(color = log10_championship_points), alpha = 0.25) +
  # geom_smooth(method = "loess", se = FALSE, aes(color = log10_championship_points)) +
  facet_wrap(~decile_group) +
  labs(title = "LOESS fit of q3 against q1 across Deciles of Championship Points",
       x = "q1 in Seconds", y = "q3 in Seconds") +
  theme(legend.position = "bottom") +
  scale_color_gradient2(low = "blue", mid = "green", high = "red", midpoint = median(max(log10_championship_points)/2, na.rm = TRUE))
```

also, fit the following linear regression model:

$$
\begin{multline}
e[\verb|q3||\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$

```{r}
```

For both the linear model and the LOESS model:

-   Plot the effect of `championship_points` on `q3`.

-   Plot the effect of `q1` on `q3` for mid-deciles (eg percentiles of order 5%, 15%, 25%, …, 95%) of `championship_points.`

Interpret both effect plots and comment on the fit the transformed linear model to the data. Also, give an interpretation of the estimated parameters in this model (apart from the intercept).

## Question 5

The original data contains missing values for `q3`, some due to the current structure of a qualifying session some due to changes in rules for qualifying. Using the models from Question 4 predict the missing values. If you now produce the same summaries as you did in Question 1 what impact has this had.

```{r}
# Your code answer here
```

## Question 6

Create a new variable `qmin` that gives the minimum time each competitor set across `q1`, `q2` and `q3`. Produce a scatterplot of `q1`against `qmin`, fitting a suitable model to these data.

```{r,message=FALSE}
# Your code answer here
qmin <- formula_tom %>% select(q1_in_seconds, q2_in_seconds, q3_in_seconds) %>%
  drop_na(q1_in_seconds, q2_in_seconds, q3_in_seconds) %>% 
  mutate(qmin = pmin(q1_in_seconds, q2_in_seconds, q3_in_seconds, na.rm = TRUE)) %>%
  select(qmin)
```

What model have you fitted, what conclusions can you draw?

## Question 7

Produce a scatterplot of `q1` and `fastest_lap`, write down and then fit a linear regression model that could be fitted to these data.

$$Your theory answer here$$

```{r,message=FALSE}
# Your code answer here
```

Which of these times would you expect to be faster based on this model? (Hint you may wish to examine the parameter estimates of the linear model).

## Question 8

For your plot produced in Question 7 add the corresponding LOESS fit. Does this change the conclusions?

```{r,message=FALSE}
# Your code answer here
```

## Question 9

Now we consider the impact of qualifying time (in particular `q1`) on `race_time`. Fit and compare the linear regression model 
$$
\begin{multline}
E[\verb|race_time||\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$
with the generalised additive model fitting the regression function (including an interaction of the explanatory variables).

$$
E[\verb|race_time||\verb|q1|,log_{10}(\verb|championship_points|)]= s(\verb|q1|,log_{10}(\verb|championship_points|))
$$
```{r,message=FALSE}
# Your code answer here
```

## Question 10

Suppose we modify the linear model used in Question 9 such that we fit
$$
\begin{multline}
E[log_{10}(\verb|race_time|)|\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$
Discuss how this would modify the interpretation of model.


## Question 11

Suppose someone wishes for you to investigate the effect of `circuit_Id` why might this be problematic?

## Question 12

Choosing a subset of 5 observations of `circuit_Id` investigate the impact of `circuit_Id` by incorporating it into your linear model from Question 9.

```{r,message=FALSE}
# Your code answer here
```

What do you conclude about the impact of circuit?