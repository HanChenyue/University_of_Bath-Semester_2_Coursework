---
title: 'MA50258: Applied Statistics'
subtitle: 'Coursework  1'
author: "09618"
output:
  html_document: 
    toc: true
    toc_float: true
    code_folding: hide
    code_download: true
---

```{r knit options, include=FALSE}
# knitting options here
knitr::opts_chunk$set(echo = TRUE, highlight = TRUE,warning = FALSE,message= FALSE)
```

```{r packages}
# indicate all your loaded packages here
library(tidyverse) 
library(readr)
library(here)

# Other loaded packages
library(lubridate)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(patchwork)
library(viridis) # Increase the number of colours available
library(broom)
```

```{r data-load}
formula_tom <- read_csv(here("data", "formula_tom.csv"))
```

## Question 1

The lap time variables (`q1`, `q2`, `q3` and `fastest_lap`) require conversion into a usable format, note the times in the raw data are recorded in minutes and seconds (where seconds are shown to three decimal places). Convert the times to seconds.

```{r,message=FALSE}
# To convert a variable q1 into minutes and seconds format we use ms()
func_convert_time_to_seconds <- function(raw_time) {
  # Check for NA or \N values and return NA for all
  if (is.na(raw_time) || raw_time == "\\N") {
    return(NA)
  }
  else {
    return(as.numeric(ms(raw_time)))
  }
}

q1_in_seconds <- sapply(formula_tom$q1, func_convert_time_to_seconds)
q2_in_seconds <- sapply(formula_tom$q2, func_convert_time_to_seconds)
q3_in_seconds <- sapply(formula_tom$q3, func_convert_time_to_seconds)
fastest_lap_in_seconds <- sapply(formula_tom$fastest_lap, func_convert_time_to_seconds)

# Adding the converted times back to the original data frame
formula_tom$q1_in_seconds <- q1_in_seconds
formula_tom$q2_in_seconds <- q2_in_seconds
formula_tom$q3_in_seconds <- q3_in_seconds
formula_tom$fastest_lap_in_seconds <- fastest_lap_in_seconds
```

## Question 2

Summarise the four lap time variables (`q1`, `q2`, `q3` and `fastest_lap`) giving minimums, means, medians and maximums.

```{r,message=FALSE}
# Function to calculate the required statistics
func_get_summary_stats <- function(x) {
  c(Minimum = min(x, na.rm = TRUE), 
    Mean = mean(x, na.rm = TRUE), 
    Median = median(x, na.rm = TRUE), 
    Maximum = max(x, na.rm = TRUE))
}

# Calculate summaries
summary_q1 <- func_get_summary_stats(q1_in_seconds)
summary_q2 <- func_get_summary_stats(q2_in_seconds)
summary_q3 <- func_get_summary_stats(q3_in_seconds)
summary_fastest_lap <- func_get_summary_stats(fastest_lap_in_seconds)

# Combine into a data frame
summary_df <- data.frame(
  Q1 = summary_q1,
  Q2 = summary_q2,
  Q3 = summary_q3,
  Fastest_Lap = summary_fastest_lap
)

kable(
  summary_df,
      caption = "Summary of Fastest Lap Times of Each Competitor",
      digits = 2,
      align = "c",
      col.names = c(
        "From 1st Qualifying Session",
        "From 2nd Qualifying Session",
        "From 3rd Qualifying Session",
        "Set Over The Race")
      ) %>%
  kable_styling("striped", full_width = F, position = "c")
```

What conclusions can you draw from your summaries?

------------------------------------------------------------------------

## Answer

```{r, message=FALSE}
kable(
  summary_df,
      caption = "Summary of Fastest Lap Times of Each Competitor",
      digits = 2,
      align = "c",
      col.names = c(
        "From 1st Qualifying Session",
        "From 2nd Qualifying Session",
        "From 3rd Qualifying Session",
        "Set Over The Race")
      ) %>%
  kable_styling("striped", full_width = F, position = "c")
```

From the summary statistics, we can see that the minimum lap times of:

i. `q1`: 53.90s

ii. `q2`: 53.65s

iii. `q3`: 53.38s

across the qualifying sessions are remarkably close. This tight clustering suggesting a high level of competitiveness to achieve the fastest possible laps across all three qualifying sessions.

The range between the minimum (55.40s) and maximum (202.30s) fastest lap times is broader in the race, suggesting that the maximum time of 202.30s is an outlier, as it is significantly higher than the mean and median times set over the race. This is further supported by the fact that the mean and median times are relatively close to each other, and the delta of mean/median time from the minimum deviates around 35s ($90\text{ seconds} - 55\text{ seconds} = 35\text{ seconds}$) instead of 112s ($202\text{ seconds} - 90\text{ seconds} = 112\text{ seconds}$) when looking at the delta between mean/median and the maximum time. 

Furthermore, by looking into the difference between the mean/median and minimum times on the fastest lap time of each competitor over the race, the 35s time range indicate the presence of diverse performances influenced by race dynamics, strategies, and driver decision-making.

------------------------------------------------------------------------

## Question 3

Produce a scatter plot of `q1` against `q3`. In the same plot, add an overlay of the fit of the corresponding LOESS fit as well as the fit of the following linear regression model:

$$E[\verb|q3||\verb|q1|]=\alpha_0 + \alpha_1 \,\verb|q1|$$

```{r, message=FALSE}
# EDA Code
ggplot(
  formula_tom,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
# Filtering out an extreme outlier (datum no. 2568 that has a lap time of 16min), this is done by setting a threshold of 180 seconds filter
formula_tom_q1_outlier_filtered <- formula_tom %>% filter(q1_in_seconds < 180)
ggplot(
  formula_tom_q1_outlier_filtered,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
formula_tom_q1_extreme_filtering  <- formula_tom %>% filter(q1_in_seconds < 135)
ggplot(
  formula_tom_q1_extreme_filtering,
  aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 Against q3",
    x = "q1 (seconds)",
    y = "q3 (seconds)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  )
```

```{r, message=FALSE}
# EDA Code
unfitted_data_points <- formula_tom %>% filter(q1_in_seconds > 135) %>% select(q1_in_seconds, q3_in_seconds)
kable(
  unfitted_data_points,
  caption = "Checking Unfitted Data Points",
  digits = 2,
  align = "c",
) %>%
  kable_styling("striped", full_width = F, position = "c")
```

What can you say about each fit, is there any agreement between them?

------------------------------------------------------------------------

## Answer

For this question, we produced a scatter plot of the fastest lap time from the 1st qualifying session (`q1`) against the fastest lap time from the 3rd qualifying session (`q3`). We also added an overlay of the fit of the corresponding LOESS fit and the fit of the linear regression model. We excluded an extreme outlier from the data set by setting a threshold of 180 seconds for the fastest lap time.

```{r,message=FALSE}
# The reason why there are some data points that aren't being shown is due to presence of missing data
# Redoing the scatter plot and excluding data points with missing data
formula_tom_no_na_q3 <- formula_tom %>% drop_na(q1_in_seconds, q3_in_seconds) %>% filter(q1_in_seconds < 180)

ggplot(formula_tom_no_na_q3, aes(x = q1_in_seconds, y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = FALSE, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = FALSE, linewidth = 0.5) +
  labs(
    title = "Scatterplot of q1 Against q3 with LOESS and Linear Model Fits",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

The LOESS smoothing fit is a non-parametric regression method that fits multiple local linear regressions to the data. The linear model fit is a parametric regression method that fits a single linear regression to the data. The LOESS smoothing fit is more flexible and can capture non-linear relationships between the variables. The linear model fit is less flexible and can only capture linear relationships between the variables.

There is a general agreement between the two fits that there is a positive correlation between `q1` and `q3` lap times although the LOESS smoothing fit is able to better capture the local fluctuations in the data. The closeness of the two lines suggests that the linear model approximates the relationship well, although the LOESS fit indicates some deviation from linearity, especially at the lower and higher ends of the `q1` time range.


```{r, message=FALSE}
# Run the linear model
lm_fit <- lm(q3_in_seconds ~ q1_in_seconds, data = formula_tom_no_na_q3)

# Tidy the linear model fit
lm_summary_q3 <- broom::tidy(lm_fit) %>% as.data.frame() %>% select(term, estimate)

# Create the table with kable
kable(lm_summary_q3,
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c",
) %>%
  kable_styling("striped", full_width = FALSE, position = "center")
```

The formula for the linear model fit is:

$$E[\verb|q3||\verb|q1|]=\alpha_0 + \alpha_1 \,\verb|q1|$$

where $\alpha_0$ is the intercept and $\alpha_1$ is the slope of the line. The estimated values of $\alpha_0$ and $\alpha_1$ are 3.48 and 0.99, respectively. This means that the expected value of `q3` increases by 0.99 seconds for every one-second increase in `q1`.

------------------------------------------------------------------------

## Question 4

Fit the LOESS empirical estimate (joint with interaction) of the regression function $s$ in the model:

$$E[\verb|q3||\verb|q1|,\verb|championship_points|]=s(\verb|q1|,log_{10}(\verb|championship_points|))$$

also, fit the following linear regression model:

$$
\begin{multline}
e[\verb|q3||\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$

```{r, message=FALSE}
# EDA Code
# Check for relationship between q1 and championship_points
formula_eda_q4 <- formula_tom %>% drop_na(championship_points, q1_in_seconds, q3_in_seconds) %>%  filter(q1_in_seconds < 180)
log10_championship_points <- log10(formula_eda_q4$championship_points + 1)
ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = championship_points)) +
  geom_point(alpha = 0.25) +
  # geom_smooth(aes(col = "loess smoothing"), method = "loess", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against q1 with Championship Points (Non Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) + 
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(formula_eda_q4$championship_points)/2, na.rm = TRUE)
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))


ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  geom_point(alpha = 0.25) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) + 
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(log10_championship_points)/2, na.rm = TRUE)
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))

# Include the deciles (Breaking up log10_championship_points into deciles)
formula_eda_q4_break_points <- formula_eda_q4 %>%
  mutate(decile = cut(log10_championship_points,
                      breaks = quantile(log10_championship_points,
                                        probs = seq(0, 1, by = 0.1)),
                      include.lowest = TRUE,
                      labels = paste0(seq(10, 100, by = 10), "%")))  # Label the deciles

ggplot(
  formula_eda_q4_break_points,
  aes(x = q1_in_seconds, y = q3_in_seconds, col = log10_championship_points)) +
  geom_point(alpha = 0.25) +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) +
  theme(legend.position = "bottom") +
  scale_colour_gradient2(
    low = "blue",
    mid = "green",
    high = "red",
    midpoint = median(max(log10_championship_points)/2, na.rm = TRUE)
  ) +
  facet_wrap(~decile, scales = "free", ncol = 4)
```

```{r, message=FALSE}
# EDA Code
# Fit the linear model with interaction
formula_tom_no_na_q4 <- formula_tom %>% drop_na(q1_in_seconds, q3_in_seconds, championship_points) # %>% filter(q1_in_seconds < 180)

# Add +1 to avoid log(0) error
formula_tom_no_na_q4_log10_championship_points <- log10(formula_tom_no_na_q4$championship_points + 1)

ggplot(
  formula_eda_q4,
  aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
      y = q3_in_seconds)) +
  geom_point(alpha = 0.25) 

# Make x-axis to be the log-transformed championship points
ggplot(
  formula_tom_no_na_q4,
  aes(x = log10_championship_points,
      y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against log10(championship_points)",
    x = "log10(championship_points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))
```

```{r, message=FALSE}
# EDA Code
# Fit the linear model with interaction
lm_model_q4 <- lm(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

# Create the table
kable(
  summary(lm_model_q4)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")
```

```{r, message=FALSE}
# Fit the LOESS model with interaction
loess_model_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)
loess_model_without_interaction_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

```

```{r, message=FALSE}
library(modelr) # For using add_prediction and data_grid functions
mid_decile_points <- quantile(formula_tom_no_na_q4_log10_championship_points, probs = seq(0.05, 0.95, by = 0.1))
mid_decile_points <- signif(mid_decile_points, digits = 3)
kable(mid_decile_points, caption = "Mid-Decile Points", align = "c")

# Add the decile information with interaction to formula_tom_no_na_q4 dataframe
pred_grid <- 
  formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(loess_model_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

# Add the decile information without interaction to formula_tom_no_na_q4 dataframe
pred_grid_without_interaction <- 
  formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(loess_model_without_interaction_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

# With interaction
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom") +
  labs(
    title = "q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  )

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom")

# Without interaction
formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid_without_interaction) +
    theme(legend.position = "bottom")

formula_tom_no_na_q4 %>%
  ggplot(
    aes(x = q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points,
        y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, colour = formula_tom_no_na_q4_log10_championship_points), data = pred_grid_without_interaction) +
    theme(legend.position = "bottom")

# Zoom in to certain dense regions
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds, y = q3_in_seconds, col = formula_tom_no_na_q4_log10_championship_points), data = pred_grid) +
    theme(legend.position = "bottom")

```

For both the linear model and the LOESS model:

-   Plot the effect of `championship_points` on `q3`.

-   Plot the effect of `q1` on `q3` for mid-deciles (eg percentiles of order 5%, 15%, 25%, …, 95%) of `championship_points.`


Interpret both effect plots and comment on the fit the transformed linear model to the data. Also, give an interpretation of the estimated parameters in this model (apart from the intercept).

------------------------------------------------------------------------

## Answer

```{r, message=FALSE}
# Plot the effect of championship points on q3
ggplot(
  formula_tom_no_na_q4,
  aes(x = log10_championship_points,
      y = q3_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "q3 Against log10(Championship Points)",
    x = "log10(Championship Points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))

# Fit the linear model with interaction
lm_model_q4 <- lm(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

# Create the table
kable(
  summary(lm_model_q4)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")

loess_model_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points + q1_in_seconds*formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)
loess_model_without_interaction_q4 <- loess(q3_in_seconds ~ q1_in_seconds + formula_tom_no_na_q4_log10_championship_points, data = formula_tom_no_na_q4)

pred_grid_lm <-  formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(lm_model_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

pred_grid_loess <-   formula_tom_no_na_q4 %>%
  data_grid(
    formula_tom_no_na_q4_log10_championship_points = mid_decile_points,
    q1_in_seconds = seq(min(formula_tom_no_na_q4$q1_in_seconds), max(formula_tom_no_na_q4$q1_in_seconds))) %>% 
  add_predictions(loess_model_q4, var = "q3_in_seconds", type = "response") %>%
  mutate(
    formula_tom_no_na_q4_log10_championship_points = factor(formula_tom_no_na_q4_log10_championship_points)
  )

# LM plot: The effect of championship points on q3 with championship points' mid-deciles
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_lm) +
  labs(
    title = "Linear Model Fit: q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    col = "log10(Championship Points)"
  ) +
  theme(legend.position = "bottom") +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
  
# LOESS plot: The effect of q1 on q3 with championship points' mid-deciles
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_loess) +
  labs(
    title = "LOESS Model Fit: q3 Against q1 with Championship Points (Log-Transformed)",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
    col = "log10(Championship Points)"
  ) +
  theme(legend.position = "bottom") +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

The linear model fit for the relationship between `q1` and `q3` with the interaction term `q1*log10(championship_points)` is given by the equation:

$$E[\verb|q3||\verb|q1|,\verb|championship_points|]=\delta_0 + \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)$$

where $\delta_0$, $\delta_1$, $\delta_2$, and $\delta_3$ are the estimated coefficients of the model. The estimated values of the coefficients are as follows:

-   $\delta_1 = 1.00$,
-   $\delta_2 = 1.51$, and
-   $\delta_3 = -0.03$.

The estimated value of $\delta_1$ is 1.00 and $\delta_3$ is -0.03.

Therefore, looking only on the variable `q1`, the expected value of `q3` increases by $1.00 + (-0.03) = 0.97$ seconds for every one-second increase in `q1`.

Looking only on the variable `log10(championship_points)`, the expected value of `q3` increases by $log_{10}(2) \times (\delta_2 + \delta_3) = log_{10}(2) \times (1.51 + (-0.03)) = 0.46$ for every twofolde increase in `championship_points`.

The linear model and loess capture the relationship between `q1`, `championship_points`, and `q3` by considering the interaction between `q1` and `championship_points`. The models provided a good fit to the data for different mid-deciles of `championship_points` to provide us a comprehensive understanding of how `q1` and `championship_points` influence `q3`. As we can see, we observed that competitors with a higher `championship_points` tend to have faster lap times in the 3rd qualifying session but it is very minor. When `q1` > 100, the effect of `championship_points` on `q3` became slight more pronounced in the LOESS fit showing us that competitors with higher `championship_points` will have a more pronounced edge by having better performance in `q3` relative to the performer having average `championship_points` (as shown below).

```{r, message=FALSE}
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_loess) +
    theme(legend.position = "bottom") +
    labs(
      title = "LOESS Model Fit: q3 Against q1 with Championship Points (Log-Transformed)",
      x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
      y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
      col = "log10(Championship Points)"
    ) +
    scale_x_continuous(labels = function(x) paste0(x, "s")) +
    scale_y_continuous(labels = function(y) paste0(y, "s")) +
    xlim(110, 130) +
    ylim(70, 130)
```

Overall, the linear model fit with the interaction term provides a comprehensive understanding of the relationship between `q1`, `championship_points`, and `q3`. The estimated coefficients of the model offer insights into how changes in the variables impact the outcome variable and provide a basis for further analysis and interpretation of the data.

------------------------------------------------------------------------

## Question 5

The original data contains missing values for `q3`, some due to the current structure of a qualifying session some due to changes in rules for qualifying. Using the models from Question 4 predict the missing values. If you now produce the same summaries as you did in Question 1 what impact has this had?

```{r, message=FALSE}
# Update the missing_q3_data to include all necessary variables for the model
missing_q3_data <- formula_tom %>%
  mutate(
    log10_championship_points = log10(championship_points + 1),
    q1_in_seconds = q1_in_seconds,  # assuming this variable is already correct in your dataset
    interaction_term = q1_in_seconds * log10(championship_points + 1)  # create interaction term as per model
  ) %>% 
  filter(is.na(q3_in_seconds)) %>%  # filter only missing q3_in_second %>% s
  filter(!is.na(interaction_term)) %>%  # filter only missing interaction term))
  select(q1_in_seconds, q3_in_seconds, log10_championship_points, interaction_term)

# Rename the columns in missing_q3_data to match the model's names
names(missing_q3_data) <- c("q1_in_seconds", "q3_in_seconds", "formula_tom_no_na_q4_log10_championship_points", "interaction_term")

# Predict q3_in_seconds using the linear model
missing_q3_data$predicted_q3_lm <- predict(lm_model_q4, newdata = missing_q3_data)

# Predict q3_in_seconds using the loess model
missing_q3_data$predicted_q3_loess <- predict(loess_model_q4, newdata = missing_q3_data)

# Summary of the predicted q3_in_seconds
# Missing data in LOESS model
kable(
  missing_q3_data %>% 
    select(q3_in_seconds, predicted_q3_lm, predicted_q3_loess) %>% 
    summary(),
  caption = "Summary of the Predicted q3_in_seconds",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")
```

```{r, message=FALSE}
formula_tom_no_na_q4 %>% 
  ggplot(
    aes(x = q1_in_seconds, y = q3_in_seconds)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = q3_in_seconds,
                  col = formula_tom_no_na_q4_log10_championship_points),
              data = pred_grid_lm) +
  labs(
    title = "q3 Against log10(championship_points)",
    x = "log10(championship_points)",
    y = "Fastest Lap Time From The 3rd Qualifying Session (q3)",
  ) 
```

```{r, message=FALSE}
ggplot() +
  geom_point(data = formula_tom_no_na_q4, aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data, aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  geom_point(data = missing_q3_data, aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LM Predictions (red), LOESS Predictions (blue)"
  )
```

```{r, message=FALSE}
# Filter out the extreme outlier
ggplot() +
  geom_point(data = formula_tom_no_na_q4 %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LM Predictions (red), LOESS Predictions (blue)"
  )
```



```{r, message=FALSE}
kable(
  missing_q3_data %>% filter(q1_in_seconds < 180) %>%
    select(q3_in_seconds, predicted_q3_lm, predicted_q3_loess) %>% 
    summary(),
  caption = "Summary of the Predicted q3_in_seconds",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")
```

---

## Answer

```{r, message=FALSE}
# Combine the tables for comparison between predicted lm, loess, and original q3 values
# Calculate summary statistics
summary_stats <- function(x) {
  c(Min = min(x, na.rm = TRUE), 
    Median = median(x, na.rm = TRUE), 
    Mean = mean(x, na.rm = TRUE), 
    Max = max(x, na.rm = TRUE))
}

predicted_q3_summary <- missing_q3_data %>% filter(q1_in_seconds < 180) %>%
  summarise(across(c(predicted_q3_lm, predicted_q3_loess), summary_stats)) %>% 
  round(2)

original_q3_summary <- summary_df %>% 
  summarise(Q3 = summary_stats(Q3)) %>% 
  round(2)

# Combine summaries
combined_summary <- bind_cols(predicted_q3_summary, original_q3_summary)

# Create the kable
kable(combined_summary, 
      caption = "Comparison of Original and Predicted q3", 
      col.names = c("Predicted Q3 (LM)", "Predicted Q3 (Loess)", "Original Q3"),
      digits = 2, 
      align = "c") %>%
  kable_styling("striped", full_width = F, position = "center")
```


```{r, message=FALSE}
# Overlay with LM prediction
ggplot() +
  geom_point(data = formula_tom_no_na_q4 %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LM Predictions (red)"
  )
```

```{r, message=FALSE}
# Overlay with LOESS prediction
ggplot() +
  geom_point(data = formula_tom_no_na_q4 %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = q3_in_seconds), colour = "black", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of Original and Predicted q3 Times",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "Original Data (black), LOESS Predictions (blue)"
  )
```

```{r, message=FALSE}
# Overlay LM and LOESS predictions
ggplot() +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_lm), colour = "red", alpha = 0.25) +
  geom_point(data = missing_q3_data %>% filter(q1_in_seconds < 180), aes(x = q1_in_seconds, y = predicted_q3_loess), colour = "blue", alpha = 0.25) +
  labs(
    title = "Overlay of LM and LOESS Predictions",
    x = "q1_in_seconds",
    y = "q3_in_seconds",
    subtitle = "LM Predictions (red), LOESS Predictions (blue)"
  )
```

Based at the table, we can see that the predicted `q3` values using the linear model and LOESS model are similar to the original `q3` values. The summary statistics of the predicted `q3` values show that the mean, median, and standard deviation are close to the original `q3` values. The overlay of the original and predicted `q3` values shows that the predicted values are close to the original values, indicating that the models provide a good fit to the data. However, when comparing across the maximum, LOESS model gives a slightly better fit than the linear model due to the tail end of the dataset will eventually drop slightly which the linear model's limitation doesn't allow it to capture this trend.

In conclusion, using the models from Question 4 to predict the missing values for `q3` has shown us that the predicted values are close to the original values, thus there won't be a significant impact on the summaries as the predicted values are close to the original values.

---

## Question 6

Create a new variable `qmin` that gives the minimum time each competitor set across `q1`, `q2` and `q3`. Produce a scatterplot of `q1`against `qmin`, fitting a suitable model to these data.



What model have you fitted, what conclusions can you draw?

---

## Answer

```{r,message=FALSE}
formula_tom_q6 <- formula_tom %>% select(q1_in_seconds, q2_in_seconds, q3_in_seconds) %>%
  drop_na(q1_in_seconds, q2_in_seconds, q3_in_seconds) %>%
  mutate(qmin = pmin(q1_in_seconds, q2_in_seconds, q3_in_seconds, na.rm = TRUE))

ggplot(
  formula_tom_q6,
  aes(x = q1_in_seconds,
      y = qmin)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "qmin Against q1",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Minimum Fastest Lap Time Across q1, q2, and q3 (qmin)",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue"))
```

I fitted both a linear model and a LOESS model to the data.

Based on the dataset, LOESS model is a better fit here given that it is much more accurate in capturing the tail end of the datapoints.

---

## Question 7

Produce a scatterplot of `q1` and `fastest_lap`, write down and then fit a linear regression model that could be fitted to these data.

Which of these times would you expect to be faster based on this model? (Hint you may wish to examine the parameter estimates of the linear model).

---

## Answer

```{r,message=FALSE}
formula_tom_q7 <- formula_tom %>%
  select(q1_in_seconds, fastest_lap_in_seconds) %>%
  drop_na(q1_in_seconds, fastest_lap_in_seconds) %>% 
  filter(q1_in_seconds < 180)  # Filtering out the 16min outlier)




lm_fit <- lm(fastest_lap_in_seconds ~ q1_in_seconds, data = formula_tom_q7)

# Get the coefficients of the linear model
coefficients <- coef(lm_fit)

# Calculate the intersection point
intersection_q1 <- coefficients[1] / (1 - coefficients[2])

# Output the intersection point
cat("The intersection point between the linear model and the theoretical line is:", round(intersection_q1, 1), "seconds\n")

ggplot(
  formula_tom_q7,
  aes(x = q1_in_seconds,
      y = fastest_lap_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F) +
  geom_abline(intercept = 0, slope = 1, linetype = "dotted", color = "red") +
  geom_vline(xintercept = intersection_q1, linetype = "dashed", color = "black") +
  labs(
    title = "Fastest Lap Against q1",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("Linear Model Fit" = "blue", "Theoretical Line" = "red")) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

The linear model fit in blue is given by the equation:

$$E[\verb|qmin||\verb|q1|]=\xi_0 + \xi_1\,\verb|q1|$$

and the red line is the theoretical line where `qmin` = `q1` where we assume a scenario where `q1` always dominates across all qualifying sessions.

$$E[\verb|qmin||\verb|q1|]=\verb|q1|$$

Based on the graph, when `q1` < 106.9s, the theoretical time is faster than the actual time. However, when `q1` > 106.9s, the actual time is faster than the theoretical time. 


---

## Question 8

For your plot produced in Question 7 add the corresponding LOESS fit. Does this change the conclusions?

---

## Answer

```{r,message=FALSE}
ggplot(
  formula_tom_q7,
  aes(x = q1_in_seconds,
      y = fastest_lap_in_seconds)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "LOESS Smoothing"), method = "loess", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  labs(
    title = "Fastest Lap Against q1",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Fastest Lap Time",
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("LOESS Smoothing" = "red", "Linear Model Fit" = "blue")) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

As shown by the red LOESS fit, the actual time is faster than the theoretical time when `q1` > 100s. This indicates that the LOESS fit provides a better representation of the relationship between `q1` and `fastest_lap` compared to the linear model fit. The LOESS fit captures the non-linear relationship between the variables and provides a more accurate representation of the data.

---

## Question 9

Now we consider the impact of qualifying time (in particular `q1`) on `race_time`. Fit and compare the linear regression model $$
\begin{multline}
E[\verb|race_time||\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$ with the generalised additive model fitting the regression function (including an interaction of the explanatory variables).

$$
E[\verb|race_time||\verb|q1|,log_{10}(\verb|championship_points|)]= s(\verb|q1|,log_{10}(\verb|championship_points|))
$$
---

## Answer

```{r,message=FALSE}
library(mgcv)

formula_tom_q9 <- formula_tom %>%
  drop_na(q1_in_seconds, championship_points, race_time) %>%
  filter(q1_in_seconds < 180) %>%  # Filtering out the 16min outlier
  mutate(
    log10_championship_points = log10(championship_points + 1)
  ) %>%
  select(q1_in_seconds, log10_championship_points, race_time)

# Fit the linear regression model with interaction
lm_model_q9 <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = formula_tom_q9)

# Fit the generalised additive model with interaction
gam_model_q9 <- gam(race_time ~ s(q1_in_seconds, log10_championship_points), data = formula_tom_q9)

# Create the table
kable(
  summary(lm_model_q9)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")

```

```{r, message=FALSE}
ggplot(
  formula_tom_q9,
  aes(x = q1_in_seconds,
      y = race_time)) +
  geom_point(alpha = 0.25) +
  geom_smooth(aes(col = "Linear Model Fit"), method = "lm", se = F, linewidth = 0.5) +
  geom_smooth(aes(col = "GAM Model Fit"), method = "gam", se = F, linewidth = 0.5) +
  labs(
    title = "Effect of q1 and Championship Points on Race Time",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Race Time"
) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Fits",
    values = c("Linear Model Fit" = "blue", "GAM Model Fit" = "red"))

```

```{r, message=FALSE}
mid_decile_points_q9 <- quantile(formula_tom_q9$log10_championship_points, probs = seq(0.05, 0.95, by = 0.1))
mid_decile_points_q9 <- signif(mid_decile_points, digits = 3)

pred_grid_q9_lm <-  formula_tom_q9 %>%
  data_grid(
    log10_championship_points = mid_decile_points_q9,
    q1_in_seconds = seq(min(formula_tom_q9$q1_in_seconds), max(formula_tom_q9$q1_in_seconds))) %>%
  add_predictions(
    lm_model_q9,
    var = "race_time",
    type = "response"
  ) %>% 
  mutate(
    log10_championship_points = factor(log10_championship_points)
  )

pred_grid_q9_gam <-  formula_tom_q9 %>%
  data_grid(
    log10_championship_points = mid_decile_points_q9,
    q1_in_seconds = seq(min(formula_tom_q9$q1_in_seconds), max(formula_tom_q9$q1_in_seconds))) %>%
  add_predictions(
    gam_model_q9,
    var = "race_time",
    type = "response"
  ) %>% 
  mutate(
    log10_championship_points = factor(log10_championship_points)
  )

# Plot for LM with interaction
formula_tom_q9 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = race_time,
                  col = log10_championship_points),
              data = pred_grid_q9_lm) +
  labs(
    title = "Linear Model Fit: q1 Against Race Time",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Race Time",
    col = "log10(Championship Points)"
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))


# Plot for GAM with interaction
formula_tom_q9 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = race_time,
                  col = log10_championship_points),
              data = pred_grid_q9_gam) +
  labs(
    title = "GAM Model Fit: q1 Against Race Time",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Race Time",
    col = "log10(Championship Points)"
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

When comparing the linear model and the generalised additive model (GAM) fit, the linear model provides a simpler representation of the relationship between `q1`, `log10(championship_points)`, and `race_time`. While the GAM fit is a much more complex fit but does not provide a significant improvement in the model fit compared to the linear model given that it is heavily influenced by the type of data and will display overfitting bias if the data is not well distributed. See the plot below when we zoom in on the data, the GAM model is heavily influenced by an extreme cluster of data points that has `race_time` values closer to 0s which is not ideal for the model. Therefore, the simpler linear regression model is preferred in this case.


```{r, message=FALSE}
# Plot for GAM with interaction
formula_tom_q9 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = race_time,
                  col = log10_championship_points),
              data = pred_grid_q9_gam) +
  labs(
    title = "GAM Model Fit: q1 Against Race Time",
    x = "Fastest Lap Time From The 1st Qualifying Session (q1)",
    y = "Race Time",
    col = "log10(Championship Points)"
  ) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s")) +
  xlim(100, 150)
```

---
  
## Question 10

Suppose we modify the linear model used in Question 9 such that we fit $$
\begin{multline}
E[log_{10}(\verb|race_time|)|\verb|q1|,log_{10}(\verb|championship_points|)]=\\
\delta_0 +  \delta_1\,\verb|q1| +\delta_2 \,log_{10}(\verb|championship_points|) + \delta_3\,\verb|q1|\,\times\,log_{10}(\verb|championship_points|)
\end{multline}
$$ Discuss how this would modify the interpretation of model.

---

## Answer

The modified linear model with the log-transformed `race_time` and `championship_points` would change the interpretation of the model coefficients. The log-transformed variables would allow for a non-linear relationship between the variables and the outcome variable, providing a more flexible model fit. The interpretation of the coefficients would be in terms of the percentage change in the outcome variable for a one-unit change in the predictor variables. The log-transformed variables would also help to stabilise the variance of the residuals and improve the model's performance. The log-transformed model would provide a better fit to the data and capture the non-linear relationship between the variables more accurately.

```{r, message=FALSE}
formula_tom_q10 <- formula_tom %>%
  drop_na(q1_in_seconds, championship_points, race_time) %>%
  # filter(q1_in_seconds < 180) %>%  # Filtering out the 16min outlier
  mutate(
    log10_championship_points = log10(championship_points + 1),
    log10_race_time = log10(race_time)
  ) %>%
  select(q1_in_seconds, log10_championship_points, log10_race_time)

# Fit the linear regression model with interaction
lm_model_q10 <- lm(log10_race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = formula_tom_q10)

mid_decile_points_q10 <- quantile(formula_tom_q10$log10_championship_points, probs = seq(0.05, 0.95, by = 0.1))
mid_decile_points_q10 <- signif(mid_decile_points, digits = 3)

pred_grid_q10_lm <-  formula_tom_q10 %>%
  data_grid(
    log10_championship_points = mid_decile_points_q10,
    q1_in_seconds = seq(min(formula_tom_q10$q1_in_seconds), max(formula_tom_q10$q1_in_seconds))) %>%
  add_predictions(
    lm_model_q10,
    var = "log10_race_time",
    type = "response"
  ) %>% 
  mutate(
    log10_championship_points = factor(log10_championship_points)
  )

# Plot for LM with interaction
formula_tom_q10 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = log10_race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = log10_race_time,
                  col = log10_championship_points),
              data = pred_grid_q10_lm)

formula_tom_q10 %>%
  ggplot(
    aes(x = q1_in_seconds,
        y = log10_race_time)) +
    geom_point(alpha = 0.25) +
    geom_line(aes(x = q1_in_seconds,
                  y = log10_race_time,
                  col = log10_championship_points),
              data = pred_grid_q10_lm) +
  ylim(3.5, 4.25) # Filter out the outlier concentration
```

---

## Question 11

Suppose someone wishes for you to investigate the effect of `circuit_Id` why might this be problematic?

---

## Answer

That is because the number of observations for each `circuit_Id` is not balanced (Refer the facet_wrap plots below where some plots has plenty of datapoints while others only have a few datapoints for us to work with). This can lead to biased results and inaccurate conclusions.

```{r, fig.height=150, fig.width=8}
formula_tom_q11 <- formula_tom %>%
  drop_na(q1_in_seconds, circuit_ID, race_time, championship_points) %>%
  mutate(
    log10_championship_points = log10(championship_points + 1)
  ) %>%
  select(q1_in_seconds, circuit_ID, race_time, championship_points)

ggplot(formula_tom_q11, aes(x = q1_in_seconds, y = race_time, col = circuit_ID)) +
  geom_point(alpha = 0.25) +
  theme(legend.position = "bottom") +
  facet_wrap(~circuit_ID, ncol = 1) +
  theme(
    strip.text.x = element_text(size = 7), # Adjust size as needed
    axis.text.x = element_text(angle = 45, hjust = 1) # Angle x axis text for space
  ) +
  labs(
    title = "Lap Times by Circuit",
    x = "Q1 Time in Seconds",
    y = "Q3 Time in Seconds",
    colour = "Circuit ID"
  ) +
  guides(col = guide_legend(ncol = 3)) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```

---

## Question 12

Choosing a subset of 5 observations of `circuit_Id` investigate the impact of `circuit_Id` by incorporating it into your linear model from Question 9.

```{r,message=FALSE}
# Select the top 5 circuits with the most observations
circuit_counts <- formula_tom_q11 %>%
  count(circuit_ID) %>%
  arrange(desc(n)) %>%
  slice(1:5) # Get the top 5

kable(circuit_counts, caption = "Top 5 Circuits with the Most Observations", align = "c", col.names = c("Circuit ID", "Number of Observations"))

```

```{r, message=FALSE}
formula_tom_q12 <- formula_tom %>%
  drop_na(q1_in_seconds, championship_points, race_time) %>%
  filter(circuit_ID %in% circuit_counts$circuit_ID) %>%
  mutate(
    log10_championship_points = log10(championship_points + 1)) %>%
  select(q1_in_seconds, log10_championship_points, circuit_ID, race_time)

# Fit the linear regression model with interaction
lm_model_q12 <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = formula_tom_q12)

# Create the lm table
kable(
  summary(lm_model_q12)$coefficients %>% 
    as.data.frame() %>% 
    select(Estimate, `Std. Error`),
  caption = "Summary of the Linear Model Fit",
  digits = 2,
  align = "c"
) %>%
  kable_styling("striped", full_width = F, position = "center")

# Fit the generalised additive model with interaction
gam_model_q12 <- gam(race_time ~ s(q1_in_seconds, log10_championship_points) + circuit_ID, data = formula_tom_q12)

# Create the gam table
summary(gam_model_q12)
```

```{r, message=FALSE}


australia <- formula_tom_q12 %>% filter(circuit_ID == "Australian Grand Prix")
british <- formula_tom_q12 %>% filter(circuit_ID == "British Grand Prix")
belgian <- formula_tom_q12 %>% filter(circuit_ID == "Belgian Grand Prix")
italian <- formula_tom_q12 %>% filter(circuit_ID == "Italian Grand Prix")
japanese <- formula_tom_q12 %>% filter(circuit_ID == "Japanese Grand Prix")

australia_lm <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = australia)
british_lm <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = british)
belgian_lm <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = belgian)
italian_lm <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = italian)
japanese_lm <- lm(race_time ~ q1_in_seconds + log10_championship_points + q1_in_seconds*log10_championship_points, data = japanese)

australia_gam <- gam(race_time ~ te(q1_in_seconds, log10_championship_points), data = australia)
british_gam <- gam(race_time ~ te(q1_in_seconds, log10_championship_points), data = british)
belgian_gam <- gam(race_time ~ te(q1_in_seconds, log10_championship_points), data = belgian)
italian_gam <- gam(race_time ~ te(q1_in_seconds, log10_championship_points), data = italian)
japanese_gam <- gam(race_time ~ te(q1_in_seconds, log10_championship_points), data = japanese)


pred_grid_for_australia <- australia %>% 
  data_grid(
    q1_in_seconds = seq(min(australia$q1_in_seconds), max(australia$q1_in_seconds)),
    log10_championship_points = seq(min(australia$log10_championship_points), max(australia$log10_championship_points))) %>% 
  add_predictions(
    australia_gam,
    var = "race_time",
    type = "response") %>%
  mutate(
    circuit_ID = factor("Australian Grand Prix")
  )

pred_grid_for_british <- british %>%
  data_grid(
    q1_in_seconds = seq(min(british$q1_in_seconds), max(british$q1_in_seconds)),
    log10_championship_points = seq(min(british$log10_championship_points), max(british$log10_championship_points))) %>% 
  add_predictions(
    british_gam,
    var = "race_time",
    type = "response") %>%
  mutate(
    circuit_ID = factor("British Grand Prix")
  )

pred_grid_for_belgian <- belgian %>%
  data_grid(
    q1_in_seconds = seq(min(belgian$q1_in_seconds), max(belgian$q1_in_seconds)),
    log10_championship_points = seq(min(belgian$log10_championship_points), max(belgian$log10_championship_points))) %>% 
  add_predictions(
    belgian_gam,
    var = "race_time",
    type = "response") %>%
  mutate(
    circuit_ID = factor("Belgian Grand Prix")
  )

pred_grid_for_italian <- italian %>%
  data_grid(
    q1_in_seconds = seq(min(italian$q1_in_seconds), max(italian$q1_in_seconds)),
    log10_championship_points = seq(min(italian$log10_championship_points), max(italian$log10_championship_points))) %>% 
  add_predictions(
    italian_gam,
    var = "race_time",
    type = "response") %>%
  mutate(
    circuit_ID = factor("Italian Grand Prix")
  )

pred_grid_for_japanese <- japanese %>%
  data_grid(
    q1_in_seconds = seq(min(japanese$q1_in_seconds), max(japanese$q1_in_seconds)),
    log10_championship_points = seq(min(japanese$log10_championship_points), max(japanese$log10_championship_points))) %>% 
  add_predictions(
    japanese_gam,
    var = "race_time",
    type = "response") %>%
  mutate(
    circuit_ID = factor("Japanese Grand Prix")
  )
```
What do you conclude about the impact of circuit?

---

## Answer

Based on the plots, we can see that the impact of the circuit on the relationship between `q1`, `log10(championship_points)`, and `race_time` is significant as each circuit has their own skill level and track characteristics that can affect the lap times. The plots show that the relationship between the variables varies across the different circuits, indicating that different circuit has a different impact on the lap times. The linear model and the generalised additive model (GAM) provide a good fit to the data for each circuit, capturing the non-linear relationship between the variables.

```{r, message=FALSE}
ggplot(
  data = formula_tom_q12,
  aes(x = q1_in_seconds, y = race_time, col = circuit_ID)) +
  geom_point(alpha = 0.25) +
  geom_smooth(
    data = pred_grid_for_australia,
    se = FALSE,
    alpha = 0.5,
    aes(x = q1_in_seconds,
        y = race_time,
        col = circuit_ID)
  ) +
  geom_smooth(
    data = pred_grid_for_british,
    se = FALSE,
    alpha = 0.5,
    aes(x = q1_in_seconds,
        y = race_time,
        col = circuit_ID)
  ) +
  geom_smooth(
    data = pred_grid_for_belgian,
    se = FALSE,
    alpha = 0.5,
    aes(x = q1_in_seconds,
        y = race_time,
        col = circuit_ID,
        )
  ) +
  geom_smooth(
    data = pred_grid_for_italian,
    se = FALSE,
    alpha = 0.5,
    aes(x = q1_in_seconds,
        y = race_time,
        col = circuit_ID)
  ) +
  geom_smooth(
    data = pred_grid_for_japanese,
    se = FALSE,
    alpha = 0.5,
    aes(x = q1_in_seconds,
        y = race_time,
        col = circuit_ID)
  ) +
  labs(
    title = "Effect of q1 and Championship Points on 5 selected circuits",
    x = "Fastest Lap Time From The 1st Qualifying Session",
    y = "Race Time",
    colour = "Circuit ID"
  ) +
  theme(legend.position = "bottom") +
  scale_color_manual(
    name = "Circuit ID",
    values = c("Australian Grand Prix" = "red", "British Grand Prix" = "blue", "Belgian Grand Prix" = "green", "Italian Grand Prix" = "purple", "Japanese Grand Prix" = "orange")
  ) +
  guides(col = guide_legend(ncol = 3)) +
  scale_x_continuous(labels = function(x) paste0(x, "s")) +
  scale_y_continuous(labels = function(y) paste0(y, "s"))
```
---